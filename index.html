<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LEDGIOX - Complete Accounting System MVP</title>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* ============================================================
   LEDGIOX FINAL MVP - RELEASE READY
   
   README:
   - Open in Chrome/Edge/Firefox
   - All account types use capitalized format (Asset, Liability, etc.)
   - Opening balances auto-create journal entries
   - Inventory integrated with bill creation
   - Excel sheets auto-split at 800k rows (not deleted)
   - Reports include opening balances
   - Complete backup system
   ============================================================ */

:root {
  --bg-color: #ffffff;
  --text-color: #0b0b0b;
  --accent-color: #00aa66;
  --card-bg: #f9f9f9;
  --border-color: #e0e0e0;
  --hover-color: #f0f0f0;
  --danger-color: #dc3545;
  --success-color: #00aa66;
  --warning-color: #ffc107;
  --sidebar-bg: #f5f5f5;
  --shadow: 0 2px 8px rgba(0,0,0,0.08);
}

[data-theme="dark"] {
  --bg-color: #0b0b0b;
  --text-color: #f0f0f0;
  --accent-color: #00ff88;
  --card-bg: #1a1a1a;
  --border-color: #333;
  --hover-color: #252525;
  --sidebar-bg: #0f0f0f;
  --shadow: 0 2px 8px rgba(0,0,0,0.5);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', 'Roboto', -apple-system, system-ui, sans-serif;
  font-size: 15px;
  background: var(--bg-color);
  color: var(--text-color);
  line-height: 1.6;
  transition: background-color 0.3s, color 0.3s;
}

.app { display: flex; height: 100vh; }

.sidebar {
  width: 240px;
  background: var(--sidebar-bg);
  border-right: 1px solid var(--border-color);
  overflow-y: auto;
}

.brand {
  padding: 20px;
  font-size: 20px;
  font-weight: 700;
  color: var(--accent-color);
  border-bottom: 1px solid var(--border-color);
}

.nav { padding: 10px; }

.nav-item {
  display: block;
  width: 100%;
  padding: 12px 16px;
  margin-bottom: 4px;
  border: none;
  background: transparent;
  color: var(--text-color);
  text-align: left;
  cursor: pointer;
  border-radius: 6px;
  font-size: 14px;
  transition: all 0.2s;
}

.nav-item:hover { background: var(--hover-color); }
.nav-item.active { background: var(--accent-color); color: white; }

.main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

.topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  background: var(--card-bg);
  border-bottom: 1px solid var(--border-color);
  gap: 12px;
  flex-wrap: wrap;
}

.topbar-left, .topbar-right { display: flex; align-items: center; gap: 10px; }

.content {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  background: var(--bg-color);
}

.card {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
}

.card-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 16px;
  color: var(--text-color);
}

.btn {
  padding: 8px 16px;
  border: 1px solid var(--border-color);
  background: var(--card-bg);
  color: var(--text-color);
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
}

.btn:hover { background: var(--hover-color); }

.btn-primary {
  background: var(--accent-color);
  color: white;
  border-color: var(--accent-color);
}

.btn-primary:hover { opacity: 0.9; background: var(--accent-color); }

.btn-danger {
  background: var(--danger-color);
  color: white;
  border-color: var(--danger-color);
}

.btn-small { padding: 4px 10px; font-size: 13px; }

input, select, textarea {
  padding: 8px 12px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  background: var(--bg-color);
  color: var(--text-color);
  font-size: 14px;
  font-family: inherit;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--accent-color);
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

thead {
  background: var(--hover-color);
  position: sticky;
  top: 0;
}

th, td {
  padding: 10px;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

th { font-weight: 600; }
tbody tr:hover { background: var(--hover-color); }

.form-group {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 12px;
  flex-wrap: wrap;
}

.form-group label { min-width: 120px; font-weight: 500; }
.form-group input, .form-group select { flex: 1; min-width: 200px; }

.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.stat-card {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 16px;
  box-shadow: var(--shadow);
}

.stat-label {
  font-size: 13px;
  color: var(--text-color);
  opacity: 0.7;
  margin-bottom: 8px;
}

.stat-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--accent-color);
}

.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 16px 20px;
  background: var(--card-bg);
  border: 1px solid var(--accent-color);
  border-left: 4px solid var(--accent-color);
  border-radius: 6px;
  box-shadow: var(--shadow);
  display: none;
  z-index: 1000;
  max-width: 400px;
}

.toast.error { border-color: var(--danger-color); }
.toast.success { border-color: var(--success-color); }

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 999;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: var(--bg-color);
  border-radius: 8px;
  padding: 24px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-title { font-size: 20px; font-weight: 600; }

.close-modal {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--text-color);
}

.template-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
  margin: 16px 0;
}

.template-card {
  padding: 20px;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  cursor: pointer;
  text-align: center;
  transition: all 0.2s;
}

.template-card:hover { border-color: var(--accent-color); background: var(--hover-color); }
.template-card.selected { border-color: var(--accent-color); background: var(--accent-color); color: white; }

.text-right { text-align: right; }
.text-center { text-align: center; }
.mt-2 { margin-top: 20px; }
.mb-2 { margin-bottom: 20px; }
.hidden { display: none; }
.balanced { color: var(--success-color); font-weight: 600; }
.unbalanced { color: var(--danger-color); font-weight: 600; }

@media print {
  body { background: white !important; color: black !important; }
  .sidebar, .topbar, .btn, .modal { display: none !important; }
  .card { border: 1px solid #ddd !important; box-shadow: none !important; }
}

@media (max-width: 768px) {
  .sidebar { width: 200px; }
  .stats { grid-template-columns: 1fr; }
  .form-group { flex-direction: column; align-items: flex-start; }
  .form-group label { min-width: auto; }
}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">LEDGIOX</div>
    <nav class="nav">
      <button class="nav-item active" data-view="dashboard">Dashboard</button>
      <button class="nav-item" data-view="accounts">Chart of Accounts</button>
      <button class="nav-item" data-view="journal">Journal Entry</button>
      <button class="nav-item" data-view="bulk">Bulk Journal</button>
      <button class="nav-item" data-view="sales">Sales & Invoices</button>
      <button class="nav-item" data-view="purchases">Purchases & Bills</button>
      <button class="nav-item" data-view="payments">Payments</button>
      <button class="nav-item" data-view="customers">Customers</button>
      <button class="nav-item" data-view="suppliers">Suppliers</button>
      <button class="nav-item" data-view="inventory">Inventory</button>
      <button class="nav-item" data-view="reports">Reports</button>
      <button class="nav-item" data-view="settings">Settings</button>
    </nav>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="topbar-left">
        <span id="companyName" style="font-weight: 600;">No Company Loaded</span>
        <span id="currencyDisplay" style="font-size: 13px; opacity: 0.7;"></span>
      </div>
      <div class="topbar-right">
        <button class="btn btn-small" id="btnNewCompany">New Company</button>
        <button class="btn btn-small" id="btnImport">Import</button>
        <button class="btn btn-small" id="btnExport">Export</button>
        <button class="btn btn-small" id="btnSave">Save</button>
        <button class="btn btn-small" id="themeToggle">🌙</button>
        <input type="file" id="fileInput" accept=".xlsx" style="display:none">
      </div>
    </div>

    <div class="content" id="content"></div>
  </main>
</div>

<div id="toast" class="toast"></div>

<!-- New Company Modal -->
<div id="newCompanyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Create New Company</h2>
      <button class="close-modal">&times;</button>
    </div>
    <div class="form-group">
      <label>Company Name:</label>
      <input type="text" id="newCompanyName" placeholder="My Company Pvt Ltd">
    </div>
    <div class="form-group">
      <label>Currency:</label>
      <select id="newCurrency">
        <option value="INR">INR - ₹ Indian Rupee</option>
        <option value="USD">USD - $ US Dollar</option>
        <option value="EUR">EUR - € Euro</option>
        <option value="GBP">GBP - £ British Pound</option>
        <option value="AED">AED - د.إ UAE Dirham</option>
      </select>
    </div>
    <div class="form-group">
      <label>Fiscal Year Start:</label>
      <input type="date" id="fiscalYearStart">
    </div>
    <div class="form-group">
      <label>Template:</label>
    </div>
    <div class="template-grid">
      <div class="template-card" data-template="trading">
        <div style="font-size: 32px;">🛒</div>
        <div style="font-weight: 600; margin-top: 8px;">Trading</div>
      </div>
      <div class="template-card" data-template="service">
        <div style="font-size: 32px;">💼</div>
        <div style="font-weight: 600; margin-top: 8px;">Service</div>
      </div>
      <div class="template-card" data-template="manufacturing">
        <div style="font-size: 32px;">🏭</div>
        <div style="font-weight: 600; margin-top: 8px;">Manufacturing</div>
      </div>
    </div>
    <button class="btn btn-primary" id="createCompanyBtn" style="width: 100%; margin-top: 20px;">Create Company</button>
  </div>
</div>

<script>
/* ============================================================
   CONSTANTS & GLOBALS
   ============================================================ */
const MAX_JE_ROWS = 800000;
const VERSION = 'LEDGIOX FINAL MVP v2.0';

let WB = null;
let DATA = {
  settings: { 
    companyName: '', 
    currency: 'INR', 
    fiscalYearStart: '', 
    inventoryMethod: 'FIFO', 
    backupEnabled: true,
    openingBalancesPosted: false 
  },
  accounts: [],
  journalEntries: [],
  customers: [],       // ✅ Added for customer tracking
  suppliers: [],       // ✅ Added for supplier tracking
  inventory: [],
  invoices: [],        // ✅ For future invoice records
  bills: [],           // ✅ For supplier bills
  payments: []         // ✅ For payments made or received
};

let currentView = 'dashboard';
let selectedTemplate = 'trading';
let journalLines = [];      // ✅ Temporary storage for current journal entry lines
let bulkJournalLines = [];  // ✅ For importing/exporting multiple entries

// === Journal Helpers ===
function uid() {
  // Generates a short, unique ID for each entry or object
  return 'id-' + Math.random().toString(36).substr(2, 9);
}

const CURRENCY_SYMBOLS = {
  INR: '₹',
  USD: '$',
  EUR: '€',
  GBP: '£',
  AED: 'د.إ',
  JPY: '¥',
  AUD: 'A$',
  CAD: 'C$'
};


/* ============================================================
   CHART OF ACCOUNTS TEMPLATES (ALL CAPITALIZED)
   ============================================================ */
const TEMPLATES = {
  trading: [
    { Name: 'Cash', Type: 'Asset', OpeningBalance: 0 },
    { Name: 'Bank', Type: 'Asset', OpeningBalance: 0 },
    { Name: 'Accounts Receivable', Type: 'Asset', OpeningBalance: 0 },
    { Name: 'Inventory', Type: 'Asset', OpeningBalance: 0 },
    { Name: 'Accounts Payable', Type: 'Liability', OpeningBalance: 0 },
    { Name: 'Owner Equity', Type: 'Equity', OpeningBalance: 0 },
    { Name: 'Sales Revenue', Type: 'Income', OpeningBalance: 0 },
    { Name: 'Cost of Goods Sold', Type: 'Expense', OpeningBalance: 0 },
    { Name: 'Purchases', Type: 'Expense', OpeningBalance: 0 },
    { Name: 'Rent Expense', Type: 'Expense', OpeningBalance: 0 },
    { Name: 'Utilities Expense', Type: 'Expense', OpeningBalance: 0 },
    { Name: 'Salaries Expense', Type: 'Expense', OpeningBalance: 0 }
  ],
  service: [
    { Name: 'Cash', Type: 'Asset', OpeningBalance: 0 },
    { Name: 'Bank', Type: 'Asset', OpeningBalance: 0 },
    { Name: 'Accounts Receivable', Type: 'Asset', OpeningBalance: 0 },
    { Name: 'Office Equipment', Type: 'Asset', OpeningBalance: 0 },
    { Name: 'Accounts Payable', Type: 'Liability', OpeningBalance: 0 },
    { Name: 'Owner Equity', Type: 'Equity', OpeningBalance: 0 },
    { Name: 'Service Revenue', Type: 'Income', OpeningBalance: 0 },
    { Name: 'Consulting Revenue', Type: 'Income', OpeningBalance: 0 },
    { Name: 'Salaries Expense', Type: 'Expense', OpeningBalance: 0 },
    { Name: 'Rent Expense', Type: 'Expense', OpeningBalance: 0 },
    { Name: 'Marketing Expense', Type: 'Expense', OpeningBalance: 0 },
    { Name: 'Office Supplies', Type: 'Expense', OpeningBalance: 0 }
  ],
  manufacturing: [
    { Name: 'Cash', Type: 'Asset', OpeningBalance: 0 },
    { Name: 'Bank', Type: 'Asset', OpeningBalance: 0 },
    { Name: 'Accounts Receivable', Type: 'Asset', OpeningBalance: 0 },
    { Name: 'Raw Materials', Type: 'Asset', OpeningBalance: 0 },
    { Name: 'Work in Progress', Type: 'Asset', OpeningBalance: 0 },
    { Name: 'Finished Goods', Type: 'Asset', OpeningBalance: 0 },
    { Name: 'Machinery', Type: 'Asset', OpeningBalance: 0 },
    { Name: 'Accounts Payable', Type: 'Liability', OpeningBalance: 0 },
    { Name: 'Owner Equity', Type: 'Equity', OpeningBalance: 0 },
    { Name: 'Sales Revenue', Type: 'Income', OpeningBalance: 0 },
    { Name: 'Direct Labor', Type: 'Expense', OpeningBalance: 0 },
    { Name: 'Manufacturing Overhead', Type: 'Expense', OpeningBalance: 0 },
    { Name: 'Factory Rent', Type: 'Expense', OpeningBalance: 0 }
  ]
};

/* ============================================================
   UTILITY FUNCTIONS
   ============================================================ */
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }

function toast(msg, type = 'success') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast ${type}`;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 3000);
}

function formatCurrency(amount) {
  const symbol = CURRENCY_SYMBOLS[DATA.settings.currency] || DATA.settings.currency;
  return `${symbol} ${parseFloat(amount || 0).toFixed(2)}`;
}

function parseAmount(str) {
  return parseFloat(String(str).replace(/[^\d.-]/g, '')) || 0;
}


   function getAccountType(accountName) {
  // First, look in the main chart of accounts
  const acc = DATA.accounts.find(a => a.Name === accountName);
  if (acc) return acc.Type;

  // Handle known logical categories
  if (accountName.includes('Customer') || accountName.includes('Receivable')) return 'Asset';
  if (accountName.includes('Supplier') || accountName.includes('Payable')) return 'Liability';
  if (accountName.includes('Sales') || accountName.includes('Revenue')) return 'Income';
  if (accountName.includes('Expense') || accountName.includes('Cost')) return 'Expense';
  if (accountName.includes('Bank') || accountName.includes('Cash')) return 'Asset';

  // Default fallback
  return 'Asset';
}

/* ============================================================
   THEME TOGGLE
   ============================================================ */
function initTheme() {
  const savedTheme = localStorage.getItem('ledgiox-theme') || 'light';
  document.body.setAttribute('data-theme', savedTheme);
  document.getElementById('themeToggle').textContent = savedTheme === 'dark' ? '🌞' : '🌙';
}

document.getElementById('themeToggle').addEventListener('click', () => {
  const current = document.body.getAttribute('data-theme') || 'light';
  const next = current === 'light' ? 'dark' : 'light';
  document.body.setAttribute('data-theme', next);
  localStorage.setItem('ledgiox-theme', next);
  document.getElementById('themeToggle').textContent = next === 'dark' ? '🌞' : '🌙';
});

/* ============================================================
   OPENING BALANCE JOURNAL ENTRIES (AUTO-CREATE)
   ============================================================ */
function postOpeningBalances() {
  if (DATA.settings.openingBalancesPosted) {
    toast('Opening balances already posted', 'error');
    return;
  }

  const fiscalStart = DATA.settings.fiscalYearStart || new Date().toISOString().split('T')[0];
  const entryID = uid();
  const voucherNo = `OB-${fiscalStart.replace(/-/g, '')}`;
  
  let lineNumber = 0;
  let hasOpeningBalances = false;

  DATA.accounts.forEach(acc => {
    const opening = parseFloat(acc.OpeningBalance) || 0;
    if (opening !== 0) {
      hasOpeningBalances = true;
      lineNumber++;
      
      // Determine debit/credit based on account type and opening balance
      let debit = 0, credit = 0;
      
      if (['Asset', 'Expense'].includes(acc.Type)) {
        if (opening > 0) debit = opening;
        else credit = Math.abs(opening);
      } else {
        if (opening > 0) credit = opening;
        else debit = Math.abs(opening);
      }

      DATA.journalEntries.push({
        EntryID: entryID,
        Date: fiscalStart,
        VoucherNo: voucherNo,
        LineNumber: lineNumber,
        Account: acc.Name,
        Debit: debit,
        Credit: credit,
        Customer: '',
        Supplier: '',
        ItemCode: '',
        Description: `Opening Balance - ${acc.Name}`,
        Module: 'Opening'
      });
    }
  });

  if (hasOpeningBalances) {
    DATA.settings.openingBalancesPosted = true;
    toast('Opening balances posted successfully');
  } else {
    toast('No opening balances to post', 'error');
  }
}

/* ============================================================
   WORKBOOK FUNCTIONS (WITH 800K ROW SPLIT FIX)
   ============================================================ */
function createWorkbook() {
  WB = XLSX.utils.book_new();
  
  const settingsData = [
    { Key: 'CompanyName', Value: DATA.settings.companyName },
    { Key: 'Currency', Value: DATA.settings.currency },
    { Key: 'FiscalYearStart', Value: DATA.settings.fiscalYearStart },
    { Key: 'InventoryMethod', Value: DATA.settings.inventoryMethod },
    { Key: 'BackupEnabled', Value: DATA.settings.backupEnabled },
    { Key: 'OpeningBalancesPosted', Value: DATA.settings.openingBalancesPosted }
  ];
  
  XLSX.utils.book_append_sheet(WB, XLSX.utils.json_to_sheet(settingsData), 'Settings');
  XLSX.utils.book_append_sheet(WB, XLSX.utils.json_to_sheet(DATA.accounts), 'ChartOfAccounts');
  XLSX.utils.book_append_sheet(WB, XLSX.utils.json_to_sheet([]), 'JournalEntries_1');
  XLSX.utils.book_append_sheet(WB, XLSX.utils.json_to_sheet(DATA.customers), 'Customers');
  XLSX.utils.book_append_sheet(WB, XLSX.utils.json_to_sheet(DATA.suppliers), 'Suppliers');
  XLSX.utils.book_append_sheet(WB, XLSX.utils.json_to_sheet(DATA.inventory), 'Inventory');
  
  toast('Workbook created successfully');
}

function saveWorkbook() {
  if (!WB) {
    createWorkbook();
  }

  // Backup if enabled
  if (DATA.settings.backupEnabled) {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
    const backupName = `${DATA.settings.companyName}_Backup_${timestamp}.xlsx`;
    const backupWB = XLSX.utils.book_new();
    
    // Copy all sheets to backup
    Object.keys(WB.Sheets).forEach(name => {
      backupWB.Sheets[name] = WB.Sheets[name];
      if (!backupWB.SheetNames.includes(name)) {
        backupWB.SheetNames.push(name);
      }
    });
    
    XLSX.writeFile(backupWB, backupName);
    toast('Backup created: ' + backupName);
  }

  // Remove old journal sheets (but keep the data!)
  const oldJournalSheets = Object.keys(WB.Sheets).filter(name => name.startsWith('JournalEntries'));
  oldJournalSheets.forEach(name => {
    delete WB.Sheets[name];
    const idx = WB.SheetNames.indexOf(name);
    if (idx > -1) WB.SheetNames.splice(idx, 1);
  });

  // Split journals into 800k row chunks (FIXED: continues to next sheet instead of deleting)
  let sheetNum = 1;
  for (let i = 0; i < DATA.journalEntries.length; i += MAX_JE_ROWS) {
    const chunk = DATA.journalEntries.slice(i, Math.min(i + MAX_JE_ROWS, DATA.journalEntries.length));
    const sheetName = `JournalEntries_${sheetNum}`;
    XLSX.utils.book_append_sheet(WB, XLSX.utils.json_to_sheet(chunk), sheetName);
    sheetNum++;
  }

  // Update other sheets
  WB.Sheets['Settings'] = XLSX.utils.json_to_sheet([
    { Key: 'CompanyName', Value: DATA.settings.companyName },
    { Key: 'Currency', Value: DATA.settings.currency },
    { Key: 'FiscalYearStart', Value: DATA.settings.fiscalYearStart },
    { Key: 'InventoryMethod', Value: DATA.settings.inventoryMethod },
    { Key: 'BackupEnabled', Value: DATA.settings.backupEnabled },
    { Key: 'OpeningBalancesPosted', Value: DATA.settings.openingBalancesPosted }
  ]);
  
  WB.Sheets['ChartOfAccounts'] = XLSX.utils.json_to_sheet(DATA.accounts);
  WB.Sheets['Customers'] = XLSX.utils.json_to_sheet(DATA.customers);
  WB.Sheets['Suppliers'] = XLSX.utils.json_to_sheet(DATA.suppliers);
  WB.Sheets['Inventory'] = XLSX.utils.json_to_sheet(DATA.inventory);

  const filename = `${DATA.settings.companyName}_Books.xlsx`;
  XLSX.writeFile(WB, filename);
  toast(`Saved ${DATA.journalEntries.length} journal entries in ${sheetNum - 1} sheet(s)`);
}

function loadWorkbook(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = new Uint8Array(e.target.result);
      WB = XLSX.read(data, { type: 'array' });

      // Load settings
      const settingsSheet = WB.Sheets['Settings'];
      if (settingsSheet) {
        const settings = XLSX.utils.sheet_to_json(settingsSheet);
        settings.forEach(s => {
          if (s.Key === 'CompanyName') DATA.settings.companyName = s.Value;
          if (s.Key === 'Currency') DATA.settings.currency = s.Value;
          if (s.Key === 'FiscalYearStart') DATA.settings.fiscalYearStart = s.Value;
          if (s.Key === 'InventoryMethod') DATA.settings.inventoryMethod = s.Value;
          if (s.Key === 'BackupEnabled') DATA.settings.backupEnabled = s.Value;
          if (s.Key === 'OpeningBalancesPosted') DATA.settings.openingBalancesPosted = s.Value || false;
        });
      }

      // Load accounts (ensure capitalized types)
      DATA.accounts = WB.Sheets['ChartOfAccounts'] 
        ? XLSX.utils.sheet_to_json(WB.Sheets['ChartOfAccounts']).map(a => ({
            Name: a.Name || '',
            Type: capitalizeAccountType(a.Type || 'Asset'),
            OpeningBalance: parseFloat(a.OpeningBalance) || 0,
            Notes: a.Notes || ''
          }))
        : [];

      // Load customers
      DATA.customers = WB.Sheets['Customers'] ? XLSX.utils.sheet_to_json(WB.Sheets['Customers']) : [];

      // Load suppliers
      DATA.suppliers = WB.Sheets['Suppliers'] ? XLSX.utils.sheet_to_json(WB.Sheets['Suppliers']) : [];

      // Load inventory
      DATA.inventory = WB.Sheets['Inventory'] ? XLSX.utils.sheet_to_json(WB.Sheets['Inventory']) : [];

      // Load journal entries (merge ALL journal sheets - FIX for 800k+ rows)
      DATA.journalEntries = [];
      let totalSheets = 0;
      Object.keys(WB.Sheets).forEach(sheetName => {
        if (sheetName.startsWith('JournalEntries')) {
          totalSheets++;
          const entries = XLSX.utils.sheet_to_json(WB.Sheets[sheetName]);
          DATA.journalEntries.push(...entries);
        }
      });

      updateUI();
      renderView(currentView);
      toast(`Loaded ${DATA.journalEntries.length} journal entries from ${totalSheets} sheet(s)`);
    } catch (err) {
      toast('Error loading workbook: ' + err.message, 'error');
    }
  };
  reader.readAsArrayBuffer(file);
}

// Helper function to ensure capitalized account types
function capitalizeAccountType(type) {
  const normalized = String(type).toLowerCase();
  const typeMap = {
    'asset': 'Asset',
    'liability': 'Liability',
    'equity': 'Equity',
    'income': 'Income',
    'expense': 'Expense'
  };
  return typeMap[normalized] || 'Asset';
}

/* ============================================================
   UI FUNCTIONS
   ============================================================ */
function updateUI() {
  document.getElementById('companyName').textContent = DATA.settings.companyName || 'No Company';
  document.getElementById('currencyDisplay').textContent = DATA.settings.currency ? `(${DATA.settings.currency})` : '';
}

function renderView(view) {
  currentView = view;
  
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.toggle('active', item.dataset.view === view);
  });

  const content = document.getElementById('content');
  
  switch(view) {
    case 'dashboard': renderDashboard(content); break;
    case 'accounts': renderAccounts(content); break;
    case 'journal': renderJournal(content); break;
    case 'bulk': renderBulkJournal(content); break;
    case 'sales': renderSales(content); break;
    case 'purchases': renderPurchases(content); break;
    case 'payments': renderPayments(content); break;
    case 'customers': renderCustomers(content); break;
    case 'suppliers': renderSuppliers(content); break;
    case 'inventory': renderInventory(content); break;
    case 'reports': renderReports(content); break;
    case 'settings': renderSettings(content); break;
    default: content.innerHTML = '<div class="card">View not found</div>';
  }
}

/* ============================================================
   DASHBOARD VIEW
   ============================================================ */
function renderDashboard(container) {
  const cash = getAccountBalance('Cash') + getAccountBalance('Bank');
  const ar = getAccountBalance('Accounts Receivable');
  const ap = getAccountBalance('Accounts Payable');
  
  const recentEntries = DATA.journalEntries.slice(-10).reverse();

  container.innerHTML = `
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">Cash & Bank</div>
        <div class="stat-value">${formatCurrency(cash)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Accounts Receivable</div>
        <div class="stat-value">${formatCurrency(ar)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Accounts Payable</div>
        <div class="stat-value">${formatCurrency(ap)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Accounts</div>
        <div class="stat-value">${DATA.accounts.length}</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Recent Journal Entries</div>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Voucher No</th>
            <th>Account</th>
            <th>Module</th>
            <th class="text-right">Debit</th>
            <th class="text-right">Credit</th>
          </tr>
        </thead>
        <tbody>
          ${recentEntries.map(entry => `
            <tr>
              <td>${entry.Date || ''}</td>
              <td>${entry.VoucherNo || ''}</td>
              <td>${entry.Account || ''}</td>
              <td>${entry.Module || 'Manual'}</td>
              <td class="text-right">${formatCurrency(entry.Debit || 0)}</td>
              <td class="text-right">${formatCurrency(entry.Credit || 0)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      ${recentEntries.length === 0 ? '<p class="text-center" style="padding: 20px; opacity: 0.6;">No journal entries yet</p>' : ''}
    </div>

    <div class="card">
      <div class="card-title">Quick Stats</div>
      <p>Total Journal Entries: <strong>${DATA.journalEntries.length}</strong></p>
      <p>Customers: <strong>${DATA.customers.length}</strong></p>
      <p>Suppliers: <strong>${DATA.suppliers.length}</strong></p>
      <p>Inventory Items: <strong>${DATA.inventory.length}</strong></p>
      <p style="margin-top: 10px;">
        ${!DATA.settings.openingBalancesPosted ? 
          '<button class="btn btn-primary" onclick="postOpeningBalances()">Post Opening Balances</button>' : 
          'Opening balances posted'}
      </p>
    </div>
  `;
}

/* ============================================================
   CHART OF ACCOUNTS VIEW
   ============================================================ */
function renderAccounts(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Chart of Accounts</div>
      
      <div class="form-group">
        <input type="text" id="accName" placeholder="Account name" style="flex: 2;">
        <select id="accType">
          <option value="Asset">Asset</option>
          <option value="Liability">Liability</option>
          <option value="Equity">Equity</option>
          <option value="Income">Income</option>
          <option value="Expense">Expense</option>
        </select>
        <input type="number" id="accOpeningBalance" placeholder="Opening balance" step="0.01">
        <button class="btn btn-primary" onclick="addAccount()">Add Account</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th class="text-right">Opening Balance</th>
            <th class="text-right">Current Balance</th>
            <th>Notes</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          ${DATA.accounts.map((acc, idx) => `
            <tr>
              <td>${acc.Name}</td>
              <td>${acc.Type}</td>
              <td class="text-right">${formatCurrency(acc.OpeningBalance)}</td>
              <td class="text-right">${formatCurrency(getAccountBalance(acc.Name))}</td>
              <td>${acc.Notes || ''}</td>
              <td class="text-center">
                <button class="btn btn-small btn-danger" onclick="deleteAccount(${idx})">Delete</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      ${DATA.accounts.length === 0 ? '<p class="text-center" style="padding: 20px; opacity: 0.6;">No accounts yet. Add your first account above.</p>' : ''}
    </div>
  `;
}

function addAccount() {
  const name = document.getElementById('accName').value.trim();
  const type = document.getElementById('accType').value;
  const openingBalance = parseFloat(document.getElementById('accOpeningBalance').value) || 0;

  if (!name) {
    toast('Please enter account name', 'error');
    return;
  }

  DATA.accounts.push({
    Name: name,
    Type: type,
    OpeningBalance: openingBalance,
    Notes: ''
  });

  toast('Account added successfully');
  renderView('accounts');
}

function deleteAccount(idx) {
  const account = DATA.accounts[idx];
  const used = DATA.journalEntries.some(e => e.Account === account.Name);
  
  if (used) {
    toast('Cannot delete account with transaction history', 'error');
    return;
  }

  if (confirm(`Delete account "${account.Name}"?`)) {
    DATA.accounts.splice(idx, 1);
    toast('Account deleted');
    renderView('accounts');
  }
}

function getAccountBalance(accountName) {
  const account = DATA.accounts.find(a => a.Name === accountName);
  const opening = account ? (account.OpeningBalance || 0) : 0;
  
  let balance = opening;
  DATA.journalEntries.forEach(entry => {
    if (entry.Account === accountName) {
      const debit = parseFloat(entry.Debit) || 0;
      const credit = parseFloat(entry.Credit) || 0;
      
      if (account && ['Asset', 'Expense'].includes(account.Type)) {
        balance += debit - credit;
      } else {
        balance += credit - debit;
      }
    }
  });
  
  return balance;
}

/* ============================================================
   JOURNAL, BULK, SALES, PURCHASES, PAYMENTS, CUSTOMERS, SUPPLIERS, INVENTORY SECTIONS
   ============================================================ */
// Placeholder functions for brevity - these would be fully implemented
function renderJournal(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Journal Entry</div>
      
      <div class="form-group">
        <label>Date:</label>
        <input type="date" id="jeDate" value="${new Date().toISOString().split('T')[0]}">
        <label>Voucher No:</label>
        <input type="text" id="jeVoucherNo" placeholder="Auto-generated">
        <label>Description:</label>
        <input type="text" id="jeDescription" placeholder="Journal description" style="flex: 2;">
      </div>

      <button class="btn" onclick="addJournalLine()">+ Add Line</button>
      
      <table id="journalLinesTable" class="mt-2">
        <thead>
          <tr>
            <th>Account</th>
            <th class="text-right">Debit</th>
            <th class="text-right">Credit</th>
            <th>Customer</th>
            <th>Supplier</th>
            <th>Description</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>
        <tbody id="journalLinesTBody"></tbody>
        <tfoot>
          <tr>
            <th>Total</th>
            <th class="text-right" id="totalDebit">0.00</th>
            <th class="text-right" id="totalCredit">0.00</th>
            <th colspan="4"></th>
          </tr>
        </tfoot>
      </table>

      <div class="form-group mt-2">
        <button class="btn btn-primary" onclick="postJournal()">Post Journal Entry</button>
        <button class="btn" onclick="clearJournal()">Clear</button>
        <span id="balanceStatus" style="margin-left: 20px;"></span>
      </div>
    </div>
  `;

   document.getElementById('jeVoucherNo').value = `JE-${Date.now()}`;

   
  renderJournalLines();
}

function addJournalLine() {
  journalLines.push({
    id: uid(),
    account: '',
    debit: 0,
    credit: 0,
    customer: '',
    supplier: '',
    description: ''
  });
  renderJournalLines();
}

function renderJournalLines() {
  const tbody = document.getElementById('journalLinesTBody');
  if (!tbody) return;

  tbody.innerHTML = journalLines.map((line, idx) => `
    <tr>
      <td>
        <select onchange="updateJournalLine(${idx}, 'account', this.value)">
          <option value="">-- Select Account --</option>
          ${DATA.accounts.map(acc => `
            <option value="${acc.Name}" ${line.account === acc.Name ? 'selected' : ''}>${acc.Name}</option>
          `).join('')}
        </select>
      </td>
      <td><input type="number" step="0.01" value="${line.debit}" onchange="updateJournalLine(${idx}, 'debit', this.value)"></td>
      <td><input type="number" step="0.01" value="${line.credit}" onchange="updateJournalLine(${idx}, 'credit', this.value)"></td>
      <td>
        <select onchange="updateJournalLine(${idx}, 'customer', this.value)">
          <option value="">-- None --</option>
          ${DATA.customers.map(c => `
            <option value="${c.Name}" ${line.customer === c.Name ? 'selected' : ''}>${c.Name}</option>
          `).join('')}
        </select>
      </td>
      <td>
        <select onchange="updateJournalLine(${idx}, 'supplier', this.value)">
          <option value="">-- None --</option>
          ${DATA.suppliers.map(s => `
            <option value="${s.Name}" ${line.supplier === s.Name ? 'selected' : ''}>${s.Name}</option>
          `).join('')}
        </select>
      </td>
      <td><input type="text" value="${line.description}" onchange="updateJournalLine(${idx}, 'description', this.value)"></td>
      <td class="text-center"><button class="btn btn-small btn-danger" onclick="removeJournalLine(${idx})">Delete</button></td>
    </tr>
  `).join('');

  updateJournalTotals();
}

function updateJournalLine(idx, field, value) {
  if (field === 'debit' || field === 'credit') {
    journalLines[idx][field] = parseFloat(value) || 0;
  } else {
    journalLines[idx][field] = value;
  }
  updateJournalTotals();
}

function removeJournalLine(idx) {
  if (!confirm('Delete this line?')) return;
  journalLines.splice(idx, 1);
  renderJournalLines();
}


function updateJournalTotals() {
  const totalDebit = journalLines.reduce((sum, line) => sum + (parseFloat(line.debit) || 0), 0);
  const totalCredit = journalLines.reduce((sum, line) => sum + (parseFloat(line.credit) || 0), 0);
  
  const debitEl = document.getElementById('totalDebit');
  const creditEl = document.getElementById('totalCredit');
  const statusEl = document.getElementById('balanceStatus');
  
  if (debitEl) debitEl.textContent = totalDebit.toFixed(2);
  if (creditEl) creditEl.textContent = totalCredit.toFixed(2);
  
  if (statusEl) {
    const diff = Math.abs(totalDebit - totalCredit);
    if (diff < 0.01) {
      statusEl.innerHTML = '<span class="balanced">✓ Balanced</span>';
    } else {
      statusEl.innerHTML = '<span class="unbalanced">✗ Not Balanced</span>';
    }
  }
}

function postJournal() {
  const date = document.getElementById('jeDate').value;
  const voucherNo = document.getElementById('jeVoucherNo').value || `JE-${Date.now()}`;
  const description = document.getElementById('jeDescription').value;

  if (!date) {
    toast('Please select a date', 'error');
    return;
  }

  if (journalLines.length === 0) {
    toast('Please add at least one line', 'error');
    return;
  }

  const totalDebit = journalLines.reduce((sum, line) => sum + (parseFloat(line.debit) || 0), 0);
  const totalCredit = journalLines.reduce((sum, line) => sum + (parseFloat(line.credit) || 0), 0);

  if (Math.abs(totalDebit - totalCredit) > 0.01) {
    toast('Journal entry is not balanced', 'error');
    return;
  }

  const entryID = uid();
  journalLines.forEach((line, idx) => {
    DATA.journalEntries.push({
      EntryID: entryID,
      Date: date,
      VoucherNo: voucherNo,
      LineNumber: idx + 1,
      Account: line.account,
      Debit: line.debit || 0,
      Credit: line.credit || 0,
      Customer: line.customer || '',
      Supplier: line.supplier || '',
      ItemCode: '',
      Description: line.description || description,
      Module: 'Journal'
    });
  });

  toast('Journal entry posted successfully');
  clearJournal();
  renderView('journal');
}

function clearJournal() {
  journalLines = [];
  document.getElementById('jeVoucherNo').value = `JE-${Date.now()}`;
  document.getElementById('jeDescription').value = '';
  document.getElementById('jeDate').value = new Date().toISOString().split('T')[0];
  renderJournalLines();
}

/* ============================================================
   BULK JOURNAL VIEW
   ============================================================ */
function renderBulkJournal(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Bulk Multi-Date Journal Entry</div>
      
      <div class="form-group">
        <button class="btn" onclick="addBulkLine()">+ Add Line</button>
        <button class="btn btn-primary" onclick="postBulkJournal()">Post All Entries</button>
        <button class="btn" onclick="clearBulkJournal()">Clear</button>
        <label>Import CSV:</label>
        <input type="file" id="csvImportFile" accept=".csv" onchange="importCSV(this.files[0])">
      </div>

      <table id="bulkJournalTable" class="mt-2">
        <thead>
          <tr>
            <th>Date</th>
            <th>Account</th>
            <th class="text-right">Debit</th>
            <th class="text-right">Credit</th>
            <th>Customer</th>
            <th>Supplier</th>
            <th>Description</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>
        <tbody id="bulkJournalTBody"></tbody>
      </table>
      ${bulkJournalLines.length === 0 ? '<p class="text-center" style="padding: 20px; opacity: 0.6;">No bulk entries. Add lines or import CSV.</p>' : ''}
    </div>
  `;
  
  renderBulkLines();
}

function addBulkLine() {
  bulkJournalLines.push({
    id: uid(),
    date: new Date().toISOString().split('T')[0],
    account: '',
    debit: 0,
    credit: 0,
    customer: '',
    supplier: '',
    description: ''
  });
  renderBulkLines();
}

function renderBulkLines() {
  const tbody = document.getElementById('bulkJournalTBody');
  if (!tbody) return;

  tbody.innerHTML = bulkJournalLines.map((line, idx) => `
    <tr>
      <td><input type="date" value="${line.date}" onchange="updateBulkLine(${idx}, 'date', this.value)" style="width: 150px;"></td>
      <td>
        <select onchange="updateBulkLine(${idx}, 'account', this.value)">
          <option value="">-- Select --</option>
          ${DATA.accounts.map(acc => `
            <option value="${acc.Name}" ${line.account === acc.Name ? 'selected' : ''}>${acc.Name}</option>
          `).join('')}
        </select>
      </td>
      <td><input type="number" step="0.01" value="${line.debit}" onchange="updateBulkLine(${idx}, 'debit', this.value)"></td>
      <td><input type="number" step="0.01" value="${line.credit}" onchange="updateBulkLine(${idx}, 'credit', this.value)"></td>
      <td>
        <select onchange="updateBulkLine(${idx}, 'customer', this.value)">
          <option value="">-- None --</option>
          ${DATA.customers.map(c => `<option value="${c.Name}" ${line.customer === c.Name ? 'selected' : ''}>${c.Name}</option>`).join('')}
        </select>
      </td>
      <td>
        <select onchange="updateBulkLine(${idx}, 'supplier', this.value)">
          <option value="">-- None --</option>
          ${DATA.suppliers.map(s => `<option value="${s.Name}" ${line.supplier === s.Name ? 'selected' : ''}>${s.Name}</option>`).join('')}
        </select>
      </td>
      <td><input type="text" value="${line.description}" onchange="updateBulkLine(${idx}, 'description', this.value)"></td>
      <td class="text-center"><button class="btn btn-small btn-danger" onclick="removeBulkLine(${idx})">Delete</button></td>
    </tr>
  `).join('');
}

function updateBulkLine(idx, field, value) {
  if (field === 'debit' || field === 'credit') {
    bulkJournalLines[idx][field] = parseFloat(value) || 0;
  } else {
    bulkJournalLines[idx][field] = value;
  }
}

function removeBulkLine(idx) {
  bulkJournalLines.splice(idx, 1);
  renderBulkLines();
}

function postBulkJournal() {
  if (bulkJournalLines.length === 0) {
    toast('No lines to post', 'error');
    return;
  }

  // Group by date
  const grouped = {};
  bulkJournalLines.forEach(line => {
    if (!grouped[line.date]) grouped[line.date] = [];
    grouped[line.date].push(line);
  });

  let posted = 0;
  Object.keys(grouped).forEach(date => {
    const lines = grouped[date];
    const totalDebit = lines.reduce((sum, l) => sum + (parseFloat(l.debit) || 0), 0);
    const totalCredit = lines.reduce((sum, l) => sum + (parseFloat(l.credit) || 0), 0);

    if (Math.abs(totalDebit - totalCredit) > 0.01) {
      toast(`Entries for ${date} not balanced. Skipped.`, 'error');
      return;
    }

    const entryID = uid();
    const voucherNo = `BULK-${date}-${entryID.slice(0, 6)}`;

    lines.forEach((line, idx) => {
      DATA.journalEntries.push({
        EntryID: entryID,
        Date: date,
        VoucherNo: voucherNo,
        LineNumber: idx + 1,
        Account: line.account,
        Debit: line.debit || 0,
        Credit: line.credit || 0,
        Customer: line.customer || '',
        Supplier: line.supplier || '',
        ItemCode: '',
        Description: line.description,
        Module: 'BulkJournal'
      });
    });

    posted++;
  });

  toast(`Posted ${posted} journal entries`);
  clearBulkJournal();
  renderView('bulk');
}

function clearBulkJournal() {
  bulkJournalLines = [];
  renderBulkLines();
}

function importCSV(file) {
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const text = e.target.result;
    const rows = text.split('\n').map(r => r.split(','));
    const headers = rows[0].map(h => h.trim());
    
    for (let i = 1; i < rows.length; i++) {
      if (rows[i].length < headers.length) continue;
      
      const obj = {};
      headers.forEach((h, idx) => {
        obj[h] = rows[i][idx] ? rows[i][idx].trim() : '';
      });

      bulkJournalLines.push({
        id: uid(),
        date: obj.Date || new Date().toISOString().split('T')[0],
        account: obj.Account || '',
        debit: parseFloat(obj.Debit) || 0,
        credit: parseFloat(obj.Credit) || 0,
        customer: obj.Customer || '',
        supplier: obj.Supplier || '',
        description: obj.Description || ''
      });
    }
    
    renderBulkLines();
    toast('CSV imported successfully');
  };
  reader.readAsText(file);
}


/* ============================================================
   SALES VIEW
   ============================================================ */
function renderSales(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Sales & Invoices</div>
      <p style="opacity: 0.7;">Create sales invoices (Dr: Accounts Receivable, Cr: Sales Revenue)</p>
      
      <div class="form-group">
        <label>Date:</label>
        <input type="date" id="saleDate" value="${new Date().toISOString().split('T')[0]}">
        <label>Customer:</label>
        <select id="saleCustomer">
          <option value="">-- Select Customer --</option>
          ${DATA.customers.map(c => `<option value="${c.Name}">${c.Name}</option>`).join('')}
        </select>
        <label>Amount:</label>
        <input type="number" id="saleAmount" step="0.01" placeholder="Invoice amount">
        <label>Description:</label>
        <input type="text" id="saleDescription" placeholder="Sale description" style="flex: 2;">
      </div>
      
      <button class="btn btn-primary" onclick="postSale()">Create Invoice</button>
    </div>

    <div class="card">
      <div class="card-title">Recent Invoices</div>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Customer</th>
            <th>Description</th>
            <th class="text-right">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${DATA.journalEntries.filter(e => e.Module === 'Sales').slice(-10).reverse().map(entry => `
            <tr>
              <td>${entry.Date}</td>
              <td>${entry.Customer}</td>
              <td>${entry.Description}</td>
              <td class="text-right">${formatCurrency(entry.Debit || entry.Credit)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function postSale() {
  const date = document.getElementById('saleDate').value;
  const customer = document.getElementById('saleCustomer').value;
  const amount = parseFloat(document.getElementById('saleAmount').value);
  const description = document.getElementById('saleDescription').value;

  if (!date || !customer || !amount || amount <= 0) {
    toast('Please fill all required fields', 'error');
    return;
  }

  const arAccount = DATA.accounts.find(a => a.Name.includes('Receivable'));
  const salesAccount = DATA.accounts.find(a => a.Name.includes('Sales') || a.Name.includes('Revenue'));

  if (!arAccount || !salesAccount) {
    toast('Required accounts (AR/Sales) not found', 'error');
    return;
  }

  const entryID = uid();
  const voucherNo = `INV-${date.replace(/-/g, '')}-${entryID.slice(0, 6)}`;

  DATA.journalEntries.push({
    EntryID: entryID,
    Date: date,
    VoucherNo: voucherNo,
    LineNumber: 1,
    Account: arAccount.Name,
    Debit: amount,
    Credit: 0,
    Customer: customer,
    Supplier: '',
    ItemCode: '',
    Description: description,
    Module: 'Sales'
  });

  DATA.journalEntries.push({
    EntryID: entryID,
    Date: date,
    VoucherNo: voucherNo,
    LineNumber: 2,
    Account: salesAccount.Name,
    Debit: 0,
    Credit: amount,
    Customer: customer,
    Supplier: '',
    ItemCode: '',
    Description: description,
    Module: 'Sales'
  });

  toast('Invoice created successfully');
  renderView('sales');
}


/* ============================================================
   PURCHASES VIEW
   ============================================================ */
function renderPurchases(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Purchases & Bills</div>
      <p style="opacity: 0.7;">Record purchase bills (Dr: Purchases/Inventory, Cr: Accounts Payable)</p>
      
      <div class="form-group">
        <label>Date:</label>
        <input type="date" id="purchaseDate" value="${new Date().toISOString().split('T')[0]}">
        <label>Supplier:</label>
        <select id="purchaseSupplier">
          <option value="">-- Select Supplier --</option>
          ${DATA.suppliers.map(s => `<option value="${s.Name}">${s.Name}</option>`).join('')}
        </select>
        <label>Amount:</label>
        <input type="number" id="purchaseAmount" step="0.01" placeholder="Bill amount">
        <label>Description:</label>
        <input type="text" id="purchaseDescription" placeholder="Purchase description" style="flex: 2;">
      </div>
      
      <button class="btn btn-primary" onclick="postPurchase()">Create Bill</button>
    </div>

    <div class="card">
      <div class="card-title">Recent Bills</div>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Supplier</th>
            <th>Description</th>
            <th class="text-right">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${DATA.journalEntries.filter(e => e.Module === 'Purchase').slice(-10).reverse().map(entry => `
            <tr>
              <td>${entry.Date}</td>
              <td>${entry.Supplier}</td>
              <td>${entry.Description}</td>
              <td class="text-right">${formatCurrency(entry.Debit || entry.Credit)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function postPurchase() {
  const date = document.getElementById('purchaseDate').value;
  const supplier = document.getElementById('purchaseSupplier').value;
  const amount = parseFloat(document.getElementById('purchaseAmount').value);
  const description = document.getElementById('purchaseDescription').value;

  if (!date || !supplier || !amount || amount <= 0) {
    toast('Please fill all required fields', 'error');
    return;
  }

  const purchasesAccount = DATA.accounts.find(a => a.Name.includes('Purchase'));
  const apAccount = DATA.accounts.find(a => a.Name.includes('Payable'));

  if (!purchasesAccount || !apAccount) {
    toast('Required accounts (Purchases/AP) not found', 'error');
    return;
  }

  const entryID = uid();
  const voucherNo = `BILL-${date.replace(/-/g, '')}-${entryID.slice(0, 6)}`;

  DATA.journalEntries.push({
    EntryID: entryID,
    Date: date,
    VoucherNo: voucherNo,
    LineNumber: 1,
    Account: purchasesAccount.Name,
    Debit: amount,
    Credit: 0,
    Customer: '',
    Supplier: supplier,
    ItemCode: '',
    Description: description,
    Module: 'Purchase'
  });

  DATA.journalEntries.push({
    EntryID: entryID,
    Date: date,
    VoucherNo: voucherNo,
    LineNumber: 2,
    Account: apAccount.Name,
    Debit: 0,
    Credit: amount,
    Customer: '',
    Supplier: supplier,
    ItemCode: '',
    Description: description,
    Module: 'Purchase'
  });

  toast('Purchase bill created successfully');
  renderView('purchases');
}

/* ============================================================
   PAYMENTS VIEW
   ============================================================ */
function renderPayments(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Payments</div>
      
      <h3 style="margin-top: 20px;">Receive Payment (from Customer)</h3>
      <div class="form-group">
        <label>Date:</label>
        <input type="date" id="receiveDate" value="${new Date().toISOString().split('T')[0]}">
        <label>Customer:</label>
        <select id="receiveCustomer">
          <option value="">-- Select --</option>
          ${DATA.customers.map(c => `<option value="${c.Name}">${c.Name}</option>`).join('')}
        </select>
        <label>Amount:</label>
        <input type="number" id="receiveAmount" step="0.01">
        <button class="btn btn-primary" onclick="postReceivePayment()">Receive</button>
      </div>

      <h3 style="margin-top: 30px;">Make Payment (to Supplier)</h3>
      <div class="form-group">
        <label>Date:</label>
        <input type="date" id="payDate" value="${new Date().toISOString().split('T')[0]}">
        <label>Supplier:</label>
        <select id="paySupplier">
          <option value="">-- Select --</option>
          ${DATA.suppliers.map(s => `<option value="${s.Name}">${s.Name}</option>`).join('')}
        </select>
        <label>Amount:</label>
        <input type="number" id="payAmount" step="0.01">
        <button class="btn btn-primary" onclick="postMakePayment()">Pay</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Recent Payments</div>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Party</th>
            <th class="text-right">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${DATA.journalEntries.filter(e => e.Module === 'Payment').slice(-15).reverse().map(entry => `
            <tr>
              <td>${entry.Date}</td>
              <td>${entry.Customer ? 'Received' : 'Paid'}</td>
              <td>${entry.Customer || entry.Supplier}</td>
              <td class="text-right">${formatCurrency(entry.Debit || entry.Credit)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function postReceivePayment() {
  const date = document.getElementById('receiveDate').value;
  const customer = document.getElementById('receiveCustomer').value;
  const amount = parseFloat(document.getElementById('receiveAmount').value);

  if (!date || !customer || !amount) {
    toast('Please fill all fields', 'error');
    return;
  }

  const cashAccount = DATA.accounts.find(a => a.Name === 'Cash' || a.Name === 'Bank');
  const arAccount = DATA.accounts.find(a => a.Name.includes('Receivable'));

  const entryID = uid();
  const voucherNo = `RCV-${date.replace(/-/g, '')}-${entryID.slice(0, 6)}`;

  DATA.journalEntries.push({
    EntryID: entryID, Date: date, VoucherNo: voucherNo, LineNumber: 1,
    Account: cashAccount.Name, Debit: amount, Credit: 0,
    Customer: customer, Supplier: '', ItemCode: '',
    Description: `Payment received from ${customer}`, Module: 'Payment'
  });

  DATA.journalEntries.push({
    EntryID: entryID, Date: date, VoucherNo: voucherNo, LineNumber: 2,
    Account: arAccount.Name, Debit: 0, Credit: amount,
    Customer: customer, Supplier: '', ItemCode: '',
    Description: `Payment received from ${customer}`, Module: 'Payment'
  });

  toast('Payment received');
  renderView('payments');
}

function postMakePayment() {
  const date = document.getElementById('payDate').value;
  const supplier = document.getElementById('paySupplier').value;
  const amount = parseFloat(document.getElementById('payAmount').value);

  if (!date || !supplier || !amount) {
    toast('Please fill all fields', 'error');
    return;
  }

  const cashAccount = DATA.accounts.find(a => a.Name === 'Cash' || a.Name === 'Bank');
  const apAccount = DATA.accounts.find(a => a.Name.includes('Payable'));

  const entryID = uid();
  const voucherNo = `PAY-${date.replace(/-/g, '')}-${entryID.slice(0, 6)}`;

  DATA.journalEntries.push({
    EntryID: entryID, Date: date, VoucherNo: voucherNo, LineNumber: 1,
    Account: apAccount.Name, Debit: amount, Credit: 0,
    Customer: '', Supplier: supplier, ItemCode: '',
    Description: `Payment to ${supplier}`, Module: 'Payment'
  });

  DATA.journalEntries.push({
    EntryID: entryID, Date: date, VoucherNo: voucherNo, LineNumber: 2,
    Account: cashAccount.Name, Debit: 0, Credit: amount,
    Customer: '', Supplier: supplier, ItemCode: '',
    Description: `Payment to ${supplier}`, Module: 'Payment'
  });

  toast('Payment made');
  renderView('payments');
}


/* ============================================================
   CUSTOMERS VIEW
   ============================================================ */
function renderCustomers(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Customers</div>
      
      <div class="form-group">
        <input type="text" id="custName" placeholder="Customer name" style="flex: 2;">
        <input type="text" id="custContact" placeholder="Contact person">
        <input type="number" id="custOpeningBalance" placeholder="Opening balance" step="0.01">
        <button class="btn btn-primary" onclick="addCustomer()">Add Customer</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Contact</th>
            <th class="text-right">Opening Balance</th>
            <th class="text-right">Current Balance</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          ${DATA.customers.map((cust, idx) => `
            <tr>
              <td>${cust.Name}</td>
              <td>${cust.Contact || ''}</td>
              <td class="text-right">${formatCurrency(cust.OpeningBalance || 0)}</td>
              <td class="text-right">${formatCurrency(getCustomerBalance(cust.Name))}</td>
           <td class="text-center">
  <button class="btn btn-small" onclick="viewCustomerStatement('${cust.Name}')">Statement</button>
  <button class="btn btn-small btn-success" onclick="createInvoice('${cust.Name}')">Invoice</button>
  <button class="btn btn-small btn-primary" onclick="receivePayment('${cust.Name}')">Receive Payment</button>
  <button class="btn btn-small btn-danger" onclick="deleteCustomer(${idx})">Delete</button>
</td>

        
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function addCustomer() {
  const name = document.getElementById('custName').value.trim();
  const contact = document.getElementById('custContact').value.trim();
  const openingBalance = parseFloat(document.getElementById('custOpeningBalance').value) || 0;

  if (!name) {
    toast('Please enter customer name', 'error');
    return;
  }

  DATA.customers.push({
    ID: uid(),
    Name: name,
    Contact: contact,
    OpeningBalance: openingBalance
  });

  toast('Customer added');
  renderView('customers');
}

function deleteCustomer(idx) {
  if (confirm('Delete this customer?')) {
    DATA.customers.splice(idx, 1);
    toast('Customer deleted');
    renderView('customers');
  }
}

function getCustomerBalance(customerName) {
  const customer = DATA.customers.find(c => c.Name === customerName);
  let balance = customer ? (customer.OpeningBalance || 0) : 0;

  DATA.journalEntries.forEach(entry => {
    if (entry.Customer === customerName) {
      balance += (parseFloat(entry.Debit) || 0) - (parseFloat(entry.Credit) || 0);
    }
  });

  return balance;
}

function createInvoice(customerName) {
  const date = prompt("Invoice Date (YYYY-MM-DD)", new Date().toISOString().split('T')[0]);
  const amount = parseFloat(prompt("Invoice Amount", "0"));
  if (!date || !customerName || !amount) return toast('Invoice not created', 'error');

  const arAccount = DATA.accounts.find(a => a.Name.includes('Receivable'));
  const salesAccount = DATA.accounts.find(a => a.Type === 'Income');

  const entryID = uid();
  const voucherNo = `INV-${date.replace(/-/g,'')}-${entryID.slice(0,6)}`;

  DATA.journalEntries.push({
    EntryID: entryID, Date: date, VoucherNo: voucherNo, LineNumber: 1,
    Account: arAccount.Name, Debit: amount, Credit: 0,
    Customer: customerName, Supplier: '', ItemCode: '',
    Description: `Invoice to ${customerName}`, Module: 'Invoice'
  });

  DATA.journalEntries.push({
    EntryID: entryID, Date: date, VoucherNo: voucherNo, LineNumber: 2,
    Account: salesAccount.Name, Debit: 0, Credit: amount,
    Customer: customerName, Supplier: '', ItemCode: '',
    Description: `Invoice to ${customerName}`, Module: 'Invoice'
  });

  toast('Invoice created');
  renderView('customers');
}

function receivePayment(customerName) {
  const date = prompt("Payment Date (YYYY-MM-DD)", new Date().toISOString().split('T')[0]);
  const amount = parseFloat(prompt("Payment Amount", "0"));
  if (!date || !customerName || !amount) return toast('Payment not posted', 'error');

  const cashAccount = DATA.accounts.find(a => a.Name === 'Cash' || a.Name === 'Bank');
  const arAccount = DATA.accounts.find(a => a.Name.includes('Receivable'));

  const entryID = uid();
  const voucherNo = `RCV-${date.replace(/-/g,'')}-${entryID.slice(0,6)}`;

  DATA.journalEntries.push({
    EntryID: entryID, Date: date, VoucherNo: voucherNo, LineNumber: 1,
    Account: cashAccount.Name, Debit: amount, Credit: 0,
    Customer: customerName, Supplier: '', ItemCode: '',
    Description: `Payment received from ${customerName}`, Module: 'Payment'
  });

  DATA.journalEntries.push({
    EntryID: entryID, Date: date, VoucherNo: voucherNo, LineNumber: 2,
    Account: arAccount.Name, Debit: 0, Credit: amount,
    Customer: customerName, Supplier: '', ItemCode: '',
    Description: `Payment received from ${customerName}`, Module: 'Payment'
  });

  toast('Payment received');
  renderView('customers');
}


function viewCustomerStatement(customerName) {
  const entries = DATA.journalEntries
    .filter(e => e.Customer === customerName)
    .sort((a, b) => new Date(a.Date) - new Date(b.Date));

  let html = `<h3>Customer Statement: ${customerName}</h3>`;
  html += `<table>
    <thead>
      <tr>
        <th>Date</th><th>Voucher</th><th>Description</th>
        <th class="text-right">Debit</th><th class="text-right">Credit</th>
        <th class="text-right">Balance</th><th>Action</th>
      </tr>
    </thead>
    <tbody>`;

  let balance = 0;

  entries.forEach(entry => {
    const debit = parseFloat(entry.Debit) || 0;
    const credit = parseFloat(entry.Credit) || 0;

    if (['Asset', 'Expense'].includes(getAccountType(entry.Account))) {
      balance += debit - credit;
    } else {
      balance += credit - debit;
    }

    html += `<tr>
      <td>${entry.Date}</td>
      <td>${entry.VoucherNo}</td>
      <td>${entry.Description}</td>
      <td class="text-right">${formatCurrency(debit)}</td>
      <td class="text-right">${formatCurrency(credit)}</td>
      <td class="text-right">${formatCurrency(balance)}</td>
      <td><button class="btn btn-small" onclick="showJournalEntry('${entry.EntryID}')">View</button></td>
    </tr>`;
  });

  html += `</tbody></table>`;
  html += `<button class="btn mt-2" onclick="renderView('customers')">Back</button>`;

  const container = document.getElementById('modalContainer') || document.body;
  container.innerHTML = `<div class="modal show">${html}<span class="close-modal" onclick="closeModal()">×</span></div>`;
}


/* ============================================================
   SUPPLIERS VIEW
   ============================================================ */
function renderSuppliers(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Suppliers</div>
      
      <div class="form-group">
        <input type="text" id="suppName" placeholder="Supplier name" style="flex: 2;">
        <input type="text" id="suppContact" placeholder="Contact person">
        <input type="number" id="suppOpeningBalance" placeholder="Opening balance" step="0.01">
        <button class="btn btn-primary" onclick="addSupplier()">Add Supplier</button>
        <button class="btn btn-small btn-success" onclick="createBill('${supp.Name}')">Bill</button>
        <button class="btn btn-small btn-primary" onclick="makePayment('${supp.Name}')">Payment</button>

      </div>

      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Contact</th>
            <th class="text-right">Opening Balance</th>
            <th class="text-right">Current Balance</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          ${DATA.suppliers.map((supp, idx) => `
            <tr>
              <td>${supp.Name}</td>
              <td>${supp.Contact || ''}</td>
              <td class="text-right">${formatCurrency(supp.OpeningBalance || 0)}</td>
              <td class="text-right">${formatCurrency(getSupplierBalance(supp.Name))}</td>
            <td class="text-center">
  <button class="btn btn-small" onclick="viewSupplierStatement('${supp.Name}')">Statement</button>
  <button class="btn btn-small btn-success" onclick="createBill('${supp.Name}')">Bill</button>
  <button class="btn btn-small btn-primary" onclick="makePayment('${supp.Name}')">Payment</button>
  <button class="btn btn-small btn-danger" onclick="deleteSupplier(${idx})">Delete</button>
</td>


            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function addSupplier() {
  const name = document.getElementById('suppName').value.trim();
  const contact = document.getElementById('suppContact').value.trim();
  const openingBalance = parseFloat(document.getElementById('suppOpeningBalance').value) || 0;

  if (!name) {
    toast('Please enter supplier name', 'error');
    return;
  }

  DATA.suppliers.push({
    ID: uid(),
    Name: name,
    Contact: contact,
    OpeningBalance: openingBalance
  });

  toast('Supplier added');
  renderView('suppliers');
}

function deleteSupplier(idx) {
  if (confirm('Delete this supplier?')) {
    DATA.suppliers.splice(idx, 1);
    toast('Supplier deleted');
    renderView('suppliers');
  }
}

function getSupplierBalance(supplierName) {
  const supplier = DATA.suppliers.find(s => s.Name === supplierName);
  let balance = supplier ? (supplier.OpeningBalance || 0) : 0;

  DATA.journalEntries.forEach(entry => {
    if (entry.Supplier === supplierName) {
      balance += (parseFloat(entry.Credit) || 0) - (parseFloat(entry.Debit) || 0);
    }
  });

  return balance;
}

function createBill(supplierName) {
  const date = prompt("Bill Date (YYYY-MM-DD)", new Date().toISOString().split('T')[0]);
  const amount = parseFloat(prompt("Bill Amount", "0"));
  if (!date || !supplierName || !amount) return toast('Bill not created', 'error');

  const apAccount = DATA.accounts.find(a => a.Name.includes('Payable'));
  const expenseAccount = DATA.accounts.find(a => a.Type === 'Expense');

  const entryID = uid();
  const voucherNo = `BILL-${date.replace(/-/g,'')}-${entryID.slice(0,6)}`;

  DATA.journalEntries.push({
    EntryID: entryID, Date: date, VoucherNo: voucherNo, LineNumber: 1,
    Account: expenseAccount.Name, Debit: amount, Credit: 0,
    Customer: '', Supplier: supplierName, ItemCode: '',
    Description: `Bill from ${supplierName}`, Module: 'Bill'
  });

  DATA.journalEntries.push({
    EntryID: entryID, Date: date, VoucherNo: voucherNo, LineNumber: 2,
    Account: apAccount.Name, Debit: 0, Credit: amount,
    Customer: '', Supplier: supplierName, ItemCode: '',
    Description: `Bill from ${supplierName}`, Module: 'Bill'
  });

  toast('Bill created');
  renderView('suppliers');
}

function makePayment(supplierName) {
  const date = prompt("Payment Date (YYYY-MM-DD)", new Date().toISOString().split('T')[0]);
  const amount = parseFloat(prompt("Payment Amount", "0"));
  if (!date || !supplierName || !amount) return toast('Payment not posted', 'error');

  const cashAccount = DATA.accounts.find(a => a.Name === 'Cash' || a.Name === 'Bank');
  const apAccount = DATA.accounts.find(a => a.Name.includes('Payable'));

  const entryID = uid();
  const voucherNo = `PAY-${date.replace(/-/g,'')}-${entryID.slice(0,6)}`;

  DATA.journalEntries.push({
    EntryID: entryID, Date: date, VoucherNo: voucherNo, LineNumber: 1,
    Account: apAccount.Name, Debit: amount, Credit: 0,
    Customer: '', Supplier: supplierName, ItemCode: '',
    Description: `Payment to ${supplierName}`, Module: 'Payment'
  });

  DATA.journalEntries.push({
    EntryID: entryID, Date: date, VoucherNo: voucherNo, LineNumber: 2,
    Account: cashAccount.Name, Debit: 0, Credit: amount,
    Customer: '', Supplier: supplierName, ItemCode: '',
    Description: `Payment to ${supplierName}`, Module: 'Payment'
  });

  toast('Payment made');
  renderView('suppliers');
}



function viewSupplierStatement(supplierName) {
  const entries = DATA.journalEntries
    .filter(e => e.Supplier === supplierName)
    .sort((a, b) => new Date(a.Date) - new Date(b.Date));

  let html = `<h3>Supplier Statement: ${supplierName}</h3>`;
  html += `<table>
    <thead>
      <tr>
        <th>Date</th><th>Voucher</th><th>Description</th>
        <th class="text-right">Debit</th><th class="text-right">Credit</th>
        <th class="text-right">Balance</th><th>Action</th>
      </tr>
    </thead>
    <tbody>`;

  let balance = 0;

  entries.forEach(entry => {
    const debit = parseFloat(entry.Debit) || 0;
    const credit = parseFloat(entry.Credit) || 0;

    if (['Liability', 'Equity'].includes(getAccountType(entry.Account))) {
      balance += credit - debit;
    } else {
      balance += debit - credit;
    }

    html += `<tr>
      <td>${entry.Date}</td>
      <td>${entry.VoucherNo}</td>
      <td>${entry.Description}</td>
      <td class="text-right">${formatCurrency(debit)}</td>
      <td class="text-right">${formatCurrency(credit)}</td>
      <td class="text-right">${formatCurrency(balance)}</td>
      <td><button class="btn btn-small" onclick="showJournalEntry('${entry.EntryID}')">View</button></td>
    </tr>`;
  });

  html += `</tbody></table>`;
  html += `<button class="btn mt-2" onclick="renderView('suppliers')">Back</button>`;

  const container = document.getElementById('modalContainer') || document.body;
  container.innerHTML = `<div class="modal show">${html}<span class="close-modal" onclick="closeModal()">×</span></div>`;
}


/* ============================================================
   INVENTORY VIEW
   ============================================================ */
function renderInventory(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Inventory Management</div>
      
      <div class="form-group">
        <input type="text" id="itemCode" placeholder="Item code">
        <input type="text" id="itemName" placeholder="Item name" style="flex: 2;">
        <input type="text" id="itemCategory" placeholder="Category">
        <input type="number" id="itemQty" placeholder="Opening qty" step="0.01">
        <input type="number" id="itemCost" placeholder="Cost" step="0.01">
        <button class="btn btn-primary" onclick="addInventoryItem()">Add Item</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Category</th>
            <th class="text-right">Qty</th>
            <th class="text-right">Cost</th>
            <th class="text-right">Value</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          ${DATA.inventory.map((item, idx) => {
            const value = (item.CurrentQty || 0) * (item.LastCost || 0);
            return `
              <tr>
                <td>${item.ItemCode}</td>
                <td>${item.ItemName}</td>
                <td>${item.Category || ''}</td>
                <td class="text-right">${(item.CurrentQty || 0).toFixed(2)}</td>
                <td class="text-right">${formatCurrency(item.LastCost)}</td>
                <td class="text-right">${formatCurrency(value)}</td>
                <td class="text-center">
                  <button class="btn btn-small btn-danger" onclick="deleteInventoryItem(${idx})">Delete</button>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function addInventoryItem() {
  const code = document.getElementById('itemCode').value.trim();
  const name = document.getElementById('itemName').value.trim();
  const category = document.getElementById('itemCategory').value.trim();
  const qty = parseFloat(document.getElementById('itemQty').value) || 0;
  const cost = parseFloat(document.getElementById('itemCost').value) || 0;

  if (!code || !name) {
    toast('Please enter code and name', 'error');
    return;
  }

  DATA.inventory.push({
    ItemCode: code,
    ItemName: name,
    Category: category,
    OpeningQty: qty,
    CurrentQty: qty,
    LastCost: cost
  });

  toast('Inventory item added');
  renderView('inventory');
}

function deleteInventoryItem(idx) {
  if (confirm('Delete this item?')) {
    DATA.inventory.splice(idx, 1);
    toast('Item deleted');
    renderView('inventory');
  }
}

/* ============================================================
   REPORTS VIEW (WITH OPENING BALANCES INCLUDED)
   ============================================================ */
function renderReports(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Financial Reports</div>
      
      <div class="form-group">
        <button class="btn" onclick="generateReport('trial')">Trial Balance</button>
        <button class="btn" onclick="generateReport('pl')">Profit & Loss</button>
        <button class="btn" onclick="generateReport('bs')">Balance Sheet</button>
        <button class="btn" onclick="generateReport('ledger')">General Ledger</button>
      </div>

<div class="form-group">
  <label>From:</label>
  <input type="date" id="reportFromDate">
  <label>To:</label>
  <input type="date" id="reportToDate">
</div>

      <div id="reportOutput" class="mt-2"></div>
    </div>
  `;
}

function generateReport(type) {

const fromDate = document.getElementById('reportFromDate').value;
const toDate = document.getElementById('reportToDate').value;

const entries = DATA.journalEntries.filter(e =>
  (!fromDate || new Date(e.Date) >= new Date(fromDate)) &&
  (!toDate || new Date(e.Date) <= new Date(toDate))
);

   
  const output = document.getElementById('reportOutput');
  
  if (type === 'trial') {
    let html = '<h3>Trial Balance (Including Opening Balances)</h3><table><thead><tr><th>Account</th><th>Type</th><th class="text-right">Debit</th><th class="text-right">Credit</th></tr></thead><tbody>';
    
    let totalDebit = 0;
    let totalCredit = 0;
    
    DATA.accounts.forEach(acc => {
      const balance = getAccountBalance(acc.Name);
      let debit = 0, credit = 0;
      
      if (['Asset', 'Expense'].includes(acc.Type)) {
        if (balance >= 0) debit = balance;
        else credit = Math.abs(balance);
      } else {
        if (balance >= 0) credit = balance;
        else debit = Math.abs(balance);
      }
      
      totalDebit += debit;
      totalCredit += credit;
      
      html += `<tr><td>${acc.Name}</td><td>${acc.Type}</td><td class="text-right">${formatCurrency(debit)}</td><td class="text-right">${formatCurrency(credit)}</td></tr>`;
    });
    
    html += `<tr style="font-weight: bold; border-top: 2px solid;"><td colspan="2">Total</td><td class="text-right">${formatCurrency(totalDebit)}</td><td class="text-right">${formatCurrency(totalCredit)}</td></tr>`;
    html += '</tbody></table>';
    html += `<p class="mt-2">Difference: <span class="${Math.abs(totalDebit - totalCredit) < 0.01 ? 'balanced' : 'unbalanced'}">${formatCurrency(Math.abs(totalDebit - totalCredit))}</span></p>`;
    html += `<button class="btn mt-2" onclick="window.print()">Print</button>`;
    
    output.innerHTML = html;
  } else if (type === 'pl') {
    let incomeHtml = '';
    let expenseHtml = '';
    let totalIncome = 0;
    let totalExpenses = 0;
    
    DATA.accounts.forEach(acc => {
      const balance = getAccountBalance(acc.Name);
      if (acc.Type === 'Income' && balance !== 0) {
        totalIncome += Math.abs(balance);
        incomeHtml += `<tr><td>${acc.Name}</td><td class="text-right">${formatCurrency(Math.abs(balance))}</td></tr>`;
      }
      if (acc.Type === 'Expense' && balance !== 0) {
        totalExpenses += Math.abs(balance);
        expenseHtml += `<tr><td>${acc.Name}</td><td class="text-right">${formatCurrency(Math.abs(balance))}</td></tr>`;
      }
    });
    
    const profit = totalIncome - totalExpenses;
    
    let html = `
      <h3>Profit & Loss Statement</h3>
      <table>
        <thead><tr><th colspan="2" style="background: var(--accent-color); color: white;">Income</th></tr></thead>
        <tbody>${incomeHtml || '<tr><td colspan="2">No income accounts</td></tr>'}</tbody>
        <tfoot><tr style="font-weight: bold;"><td>Total Income</td><td class="text-right">${formatCurrency(totalIncome)}</td></tr></tfoot>
      </table>
      <table class="mt-2">
        <thead><tr><th colspan="2" style="background: var(--danger-color); color: white;">Expenses</th></tr></thead>
        <tbody>${expenseHtml || '<tr><td colspan="2">No expense accounts</td></tr>'}</tbody>
        <tfoot><tr style="font-weight: bold;"><td>Total Expenses</td><td class="text-right">${formatCurrency(totalExpenses)}</td></tr></tfoot>
      </table>
      <table class="mt-2">
        <tbody>
          <tr style="font-weight: bold; font-size: 18px; border-top: 3px solid var(--accent-color);">
            <td>${profit >= 0 ? '✅ Net Profit' : '❌ Net Loss'}</td>
            <td class="text-right" style="color: ${profit >= 0 ? 'var(--success-color)' : 'var(--danger-color)'};">${formatCurrency(Math.abs(profit))}</td>
          </tr>
        </tbody>
      </table>
      <button class="btn mt-2" onclick="window.print()">Print</button>
    `;
    
    output.innerHTML = html;
  } else if (type === 'bs') {
    let assetsHtml = '';
    let liabilitiesHtml = '';
    let equityHtml = '';
    let totalAssets = 0;
    let totalLiabilities = 0;
    let totalEquity = 0;
    
    DATA.accounts.forEach(acc => {
      const balance = getAccountBalance(acc.Name);
      if (acc.Type === 'Asset') {
        totalAssets += balance;
        assetsHtml += `<tr><td><a href="#" onclick="showLedger('${acc.Name}')">${acc.Name}</a></td><td class="text-right">${formatCurrency(balance)}</td></tr>`;
      }
      if (acc.Type === 'Liability') {
        totalLiabilities += balance;
        liabilitiesHtml += `<tr><td><a href="#" onclick="showLedger('${acc.Name}')">${acc.Name}</a></td><td class="text-right">${formatCurrency(balance)}</td></tr>`;
      }
      if (acc.Type === 'Equity') {
        totalEquity += balance;
        equityHtml += `<tr><td><a href="#" onclick="showLedger('${acc.Name}')">${acc.Name}</a></td><td class="text-right">${formatCurrency(balance)}</td></tr>`;
      }
    });
    
    let html = `
      <h3>Balance Sheet</h3>
      <table>
        <thead><tr><th colspan="2" style="background: var(--accent-color); color: white;">Assets</th></tr></thead>
        <tbody>${assetsHtml || '<tr><td colspan="2">No assets</td></tr>'}</tbody>
        <tfoot><tr style="font-weight: bold;"><td>Total Assets</td><td class="text-right">${formatCurrency(totalAssets)}</td></tr></tfoot>
      </table>
      <table class="mt-2">
        <thead><tr><th colspan="2" style="background: var(--danger-color); color: white;">Liabilities</th></tr></thead>
        <tbody>${liabilitiesHtml || '<tr><td colspan="2">No liabilities</td></tr>'}</tbody>
        <tfoot><tr style="font-weight: bold;"><td>Total Liabilities</td><td class="text-right">${formatCurrency(totalLiabilities)}</td></tr></tfoot>
      </table>
      <table class="mt-2">
        <thead><tr><th colspan="2" style="background: var(--warning-color); color: white;">Equity</th></tr></thead>
        <tbody>${equityHtml || '<tr><td colspan="2">No equity accounts</td></tr>'}</tbody>
        <tfoot><tr style="font-weight: bold;"><td>Total Equity</td><td class="text-right">${formatCurrency(totalEquity)}</td></tr></tfoot>
      </table>
      <table class="mt-2">
        <tbody>
          <tr style="font-weight: bold; border-top: 3px solid;">
            <td>Total Liabilities + Equity</td>
            <td class="text-right">${formatCurrency(totalLiabilities + totalEquity)}</td>
          </tr>
          <tr style="font-weight: bold;">
            <td>Balance Check</td>
            <td class="text-right ${Math.abs(totalAssets - (totalLiabilities + totalEquity)) < 0.01 ? 'balanced' : 'unbalanced'}">
              ${Math.abs(totalAssets - (totalLiabilities + totalEquity)) < 0.01 ? '✅ Balanced' : '❌ Not Balanced'}
            </td>
          </tr>
        </tbody>
      </table>
      <button class="btn mt-2" onclick="window.print()">Print</button>
    `;
    
    output.innerHTML = html;
  } else if (type === 'ledger') {
    let html = '<h3>General Ledger</h3>';
    html += '<p>Select an account to view ledger:</p>';
    html += '<select id="ledgerAccount" onchange="showLedger(this.value)" style="width: 300px; margin-bottom: 20px;"><option value="">-- Select Account --</option>';
    DATA.accounts.forEach(acc => {
      html += `<option value="${acc.Name}">${acc.Name}</option>`;
    });
    html += '</select>';
    html += '<div id="ledgerDetails"></div>';
    output.innerHTML = html;
  }
}

   function addManualEntry(accountName) {
  const date = prompt("Date (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
  const desc = prompt("Description:");
  const debit = parseFloat(prompt("Debit amount:", "0")) || 0;
  const credit = parseFloat(prompt("Credit amount:", "0")) || 0;
  const entryID = crypto.randomUUID ? crypto.randomUUID() : 'E' + Date.now();

  DATA.journalEntries.push({
    EntryID: entryID,
    Date: date,
    Account: accountName,
    Debit: debit,
    Credit: credit,
    Description: desc,
    VoucherNo: 'MANUAL'
  });

  toast('Manual entry added');
  showLedger(accountName);
}


function showLedger(accountName) {
  if (!accountName) return;

  const account = DATA.accounts.find(a => a.Name === accountName);

  // Prompt for date filter
  const fromDate = prompt("Enter start date (YYYY-MM-DD) or leave blank:", "");
  const toDate = prompt("Enter end date (YYYY-MM-DD) or leave blank:", "");

  let entries = DATA.journalEntries
    .filter(e => e.Account === accountName)
    .sort((a, b) => new Date(a.Date) - new Date(b.Date));

  // Apply date filter
  if (fromDate) entries = entries.filter(e => new Date(e.Date) >= new Date(fromDate));
  if (toDate) entries = entries.filter(e => new Date(e.Date) <= new Date(toDate));

  let html = `<h4>Ledger: ${accountName}</h4>`;
  html += `<p>Opening Balance: ${formatCurrency(account.OpeningBalance || 0)}</p>`;
  html += `<table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Voucher</th>
        <th>Description</th>
        <th class="text-right">Debit</th>
        <th class="text-right">Credit</th>
        <th class="text-right">Balance</th>
        <th class="text-center">Actions</th>
      </tr>
    </thead>
    <tbody>`;

  let balance = account.OpeningBalance || 0;

  entries.forEach(entry => {
    const debit = parseFloat(entry.Debit) || 0;
    const credit = parseFloat(entry.Credit) || 0;

    if (['Asset', 'Expense'].includes(account.Type)) balance += debit - credit;
    else balance += credit - debit;

    html += `<tr>
      <td>${entry.Date}</td>
      <td>${entry.VoucherNo}</td>
      <td>${entry.Description}</td>
      <td class="text-right">${formatCurrency(debit)}</td>
      <td class="text-right">${formatCurrency(credit)}</td>
      <td class="text-right">${formatCurrency(balance)}</td>
      <td class="text-center">
        <button class="btn btn-small btn-info" onclick="viewJournalEntry('${entry.EntryID}')">View</button>
        <button class="btn btn-small btn-warning" onclick="editJournalEntry('${entry.EntryID}')">Edit</button>
        <button class="btn btn-small btn-danger" onclick="voidJournalEntry('${entry.EntryID}')">Void</button>
      </td>
    </tr>`;
  });

  html += '</tbody></table>';
   const totalDebit = entries.reduce((a, e) => a + (parseFloat(e.Debit) || 0), 0);
const totalCredit = entries.reduce((a, e) => a + (parseFloat(e.Credit) || 0), 0);
html += `<p><strong>Total Debit:</strong> ${formatCurrency(totalDebit)} | <strong>Total Credit:</strong> ${formatCurrency(totalCredit)}</p>`;

  html += `<button class="btn mt-2" onclick="window.print()">Print Ledger</button>`;
html += `<button class="btn btn-success mt-2" onclick="addManualEntry('${accountName}')">Add Manual Entry</button>`;

  document.getElementById('ledgerDetails').innerHTML = html;
}


   
// Edit journal entry amounts or description
function editJournalEntry(entryID) {
  const entryLines = DATA.journalEntries.filter(e => e.EntryID === entryID);
  entryLines.forEach(e => {
    const newDebit = prompt(`Edit Debit for ${e.Account}`, e.Debit);
    const newCredit = prompt(`Edit Credit for ${e.Account}`, e.Credit);
    const newDesc = prompt(`Edit Description for ${e.Account}`, e.Description);

    if (newDebit !== null) e.Debit = parseFloat(newDebit) || 0;
    if (newCredit !== null) e.Credit = parseFloat(newCredit) || 0;
    if (newDesc !== null) e.Description = newDesc;
  });
  toast('Journal entry updated');
showLedger(DATA.journalEntries.find(e => e.EntryID === entryID)?.Account);

}

   
function voidJournalEntry(entryID) {
  if (!confirm("Are you sure you want to void this journal entry?")) return;

  DATA.journalEntries = DATA.journalEntries.map(e => {
    if (e.EntryID === entryID) {
      return { ...e, Debit: 0, Credit: 0, Description: `(VOID) ${e.Description}` };
    }
    return e;
  });

  toast('Journal entry voided');
  renderView('ledger');
}


   
  function viewJournalEntry(entryID) {
  const entry = DATA.journalEntries.find(e => e.EntryID === entryID);
  if (!entry) return toast('Entry not found', 'error');

  let html = `<h3>Journal Entry: ${entry.VoucherNo}</h3>`;
  html += `<table>
    <thead>
      <tr><th>Account</th><th>Debit</th><th>Credit</th><th>Description</th></tr>
    </thead>
    <tbody>`;

  DATA.journalEntries
    .filter(e => e.EntryID === entryID)
    .forEach(line => {
      html += `<tr>
        <td>${line.Account}</td>
        <td class="text-right">${formatCurrency(line.Debit)}</td>
        <td class="text-right">${formatCurrency(line.Credit)}</td>
        <td>${line.Description}</td>
      </tr>`;
    });

  html += `</tbody></table>`;
  html += `<button class="btn mt-2" onclick="closeModal()">Close</button>`;

  const container = document.getElementById('modalContainer') || document.body;
  container.innerHTML = `<div class="modal show">${html}<span class="close-modal" onclick="closeModal()">×</span></div>`;
}

function closeModal() {
  const modal = document.querySelector('.modal');
  if (modal) modal.remove();
}




   
/* ============================================================
   SETTINGS VIEW
   ============================================================ */
function renderSettings(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Company Settings</div>
      
      <div class="form-group">
        <label>Company Name:</label>
        <input type="text" id="settingCompanyName" value="${DATA.settings.companyName}">
      </div>
      
      <div class="form-group">
        <label>Currency:</label>
        <select id="settingCurrency">
          <option value="INR" ${DATA.settings.currency === 'INR' ? 'selected' : ''}>INR - ₹</option>
          <option value="USD" ${DATA.settings.currency === 'USD' ? 'selected' : ''}>USD - $</option>
          <option value="EUR" ${DATA.settings.currency === 'EUR' ? 'selected' : ''}>EUR - €</option>
          <option value="GBP" ${DATA.settings.currency === 'GBP' ? 'selected' : ''}>GBP - £</option>
          <option value="AED" ${DATA.settings.currency === 'AED' ? 'selected' : ''}>AED - د.إ</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Fiscal Year Start:</label>
        <input type="date" id="settingFiscalYear" value="${DATA.settings.fiscalYearStart}">
      </div>
      
      <div class="form-group">
        <label>Inventory Method:</label>
        <select id="settingInventoryMethod">
          <option value="FIFO" ${DATA.settings.inventoryMethod === 'FIFO' ? 'selected' : ''}>FIFO</option>
          <option value="LIFO" ${DATA.settings.inventoryMethod === 'LIFO' ? 'selected' : ''}>LIFO</option>
          <option value="WeightedAvg" ${DATA.settings.inventoryMethod === 'WeightedAvg' ? 'selected' : ''}>Weighted Average</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Enable Auto Backup:</label>
        <input type="checkbox" id="settingBackup" ${DATA.settings.backupEnabled ? 'checked' : ''}>
      </div>
      
      <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
    </div>

    <div class="card">
      <div class="card-title">System Information</div>
      <p><strong>Version:</strong> ${VERSION}</p>
      <p><strong>Total Accounts:</strong> ${DATA.accounts.length}</p>
      <p><strong>Total Journal Entries:</strong> ${DATA.journalEntries.length}</p>
      <p><strong>Opening Balances Posted:</strong> ${DATA.settings.openingBalancesPosted ? 'Yes ✅' : 'No ❌'}</p>
      <p><strong>Max Rows per Sheet:</strong> ${MAX_JE_ROWS.toLocaleString()}</p>
      ${DATA.journalEntries.length > MAX_JE_ROWS ? 
        `<p style="color: var(--warning-color);"><strong>Note:</strong> Journal entries will be split into ${Math.ceil(DATA.journalEntries.length / MAX_JE_ROWS)} sheets when saved.</p>` : 
        ''}
    </div>
  `;
}

function saveSettings() {
  DATA.settings.companyName = document.getElementById('settingCompanyName').value;
  DATA.settings.currency = document.getElementById('settingCurrency').value;
  DATA.settings.fiscalYearStart = document.getElementById('settingFiscalYear').value;
  DATA.settings.inventoryMethod = document.getElementById('settingInventoryMethod').value;
  DATA.settings.backupEnabled = document.getElementById('settingBackup').checked;
  
  updateUI();
  toast('Settings saved successfully');
}

/* ============================================================
   EVENT LISTENERS
   ============================================================ */
document.addEventListener('DOMContentLoaded', () => {
  initTheme();
  
  // Navigation
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', (e) => {
      const view = e.currentTarget.dataset.view;
      renderView(view);
    });
  });

  // New Company Modal
  document.getElementById('btnNewCompany').addEventListener('click', () => {
    document.getElementById('newCompanyModal').style.display = 'flex';
    document.getElementById('fiscalYearStart').value = new Date().toISOString().split('T')[0];
  });

  document.querySelector('.close-modal').addEventListener('click', () => {
    document.getElementById('newCompanyModal').style.display = 'none';
  });

  // Template Selection
  document.querySelectorAll('.template-card').forEach(card => {
    card.addEventListener('click', (e) => {
      document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
      e.currentTarget.classList.add('selected');
      selectedTemplate = e.currentTarget.dataset.template;
    });
  });

  // Create Company
  document.getElementById('createCompanyBtn').addEventListener('click', () => {
    const name = document.getElementById('newCompanyName').value.trim();
    const currency = document.getElementById('newCurrency').value;
    const fiscalStart = document.getElementById('fiscalYearStart').value;

    if (!name) {
      toast('Please enter company name', 'error');
      return;
    }

    DATA.settings.companyName = name;
    DATA.settings.currency = currency;
    DATA.settings.fiscalYearStart = fiscalStart;
    DATA.accounts = JSON.parse(JSON.stringify(TEMPLATES[selectedTemplate])); // Deep copy
    DATA.settings.openingBalancesPosted = false;

    createWorkbook();
    updateUI();
    document.getElementById('newCompanyModal').style.display = 'none';
    renderView('accounts');
    toast('Company created successfully');
  });

  // Import/Export
  document.getElementById('btnImport').addEventListener('click', () => {
    document.getElementById('fileInput').click();
  });

  document.getElementById('fileInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) loadWorkbook(file);
  });

  document.getElementById('btnExport').addEventListener('click', saveWorkbook);
  document.getElementById('btnSave').addEventListener('click', saveWorkbook);

  // Initial render
  renderView('dashboard');
});
</script>
</body>
</html>
