<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LEDGIOX - Offline Accounting System</title>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* ============================================================
   LEDGIOX Standalone MVP v2
   
   README:
   - Open this file in a browser (Chrome/Edge recommended)
   - Create company ‚Üí Choose template ‚Üí Add data ‚Üí Auto-saves to Excel
   - Import/Export .xlsx files for backup
   - To adjust MAX_JE_ROWS, edit the constant below in JavaScript
   - To wrap with Tauri: Create new Tauri project, place this in src/
   - Backups are saved as "CompanyName_Books_TIMESTAMP.xlsx"
   ============================================================ */

:root {
  --bg-color: #ffffff;
  --text-color: #0b0b0b;
  --accent-color: #00aa66;
  --card-bg: #f9f9f9;
  --border-color: #e0e0e0;
  --hover-color: #f0f0f0;
  --danger-color: #dc3545;
  --success-color: #00aa66;
  --warning-color: #ffc107;
  --sidebar-bg: #f5f5f5;
  --shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: background-color 0.3s, color 0.3s;
}

[data-theme="dark"] {
  --bg-color: #0b0b0b;
  --text-color: #f0f0f0;
  --accent-color: #00ff88;
  --card-bg: #1a1a1a;
  --border-color: #333;
  --hover-color: #252525;
  --sidebar-bg: #0f0f0f;
  --shadow: 0 2px 8px rgba(0,0,0,0.5);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', 'Roboto', -apple-system, system-ui, sans-serif;
  font-size: 15px;
  background: var(--bg-color);
  color: var(--text-color);
  line-height: 1.6;
  transition: background-color 0.3s, color 0.3s;
}

.app { display: flex; height: 100vh; }

.sidebar {
  width: 240px;
  background: var(--sidebar-bg);
  border-right: 1px solid var(--border-color);
  overflow-y: auto;
  transition: background-color 0.3s;
}

.brand {
  padding: 20px;
  font-size: 20px;
  font-weight: 700;
  color: var(--accent-color);
  border-bottom: 1px solid var(--border-color);
}

.nav { padding: 10px; }

.nav-item {
  display: block;
  width: 100%;
  padding: 12px 16px;
  margin-bottom: 4px;
  border: none;
  background: transparent;
  color: var(--text-color);
  text-align: left;
  cursor: pointer;
  border-radius: 6px;
  font-size: 14px;
  transition: all 0.2s;
}

.nav-item:hover { background: var(--hover-color); }
.nav-item.active { background: var(--accent-color); color: white; }

.main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

.topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 20px;
  background: var(--card-bg);
  border-bottom: 1px solid var(--border-color);
  gap: 12px;
  flex-wrap: wrap;
}

.topbar-left, .topbar-right { display: flex; align-items: center; gap: 10px; }

.content {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  background: var(--bg-color);
}

.card {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
}

.card-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 16px;
  color: var(--text-color);
}

.btn {
  padding: 8px 16px;
  border: 1px solid var(--border-color);
  background: var(--card-bg);
  color: var(--text-color);
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
}

.btn:hover { background: var(--hover-color); }

.btn-primary {
  background: var(--accent-color);
  color: white;
  border-color: var(--accent-color);
}

.btn-primary:hover { opacity: 0.9; background: var(--accent-color); }

.btn-danger {
  background: var(--danger-color);
  color: white;
  border-color: var(--danger-color);
}

.btn-small { padding: 4px 10px; font-size: 13px; }

input, select, textarea {
  padding: 8px 12px;
  border: 1px solid var(--border-color);
  border-radius: 6px;
  background: var(--bg-color);
  color: var(--text-color);
  font-size: 14px;
  font-family: inherit;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--accent-color);
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

thead {
  background: var(--hover-color);
  position: sticky;
  top: 0;
}

th, td {
  padding: 10px;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

th { font-weight: 600; }

tbody tr:hover { background: var(--hover-color); }

.form-group {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-bottom: 12px;
  flex-wrap: wrap;
}

.form-group label { min-width: 120px; font-weight: 500; }
.form-group input, .form-group select { flex: 1; min-width: 200px; }

.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.stat-card {
  background: var(--card-bg);
  border: 1px solid var(--border-color);
  border-radius: 8px;
  padding: 16px;
  box-shadow: var(--shadow);
}

.stat-label {
  font-size: 13px;
  color: var(--text-color);
  opacity: 0.7;
  margin-bottom: 8px;
}

.stat-value {
  font-size: 24px;
  font-weight: 700;
  color: var(--accent-color);
}

.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  padding: 16px 20px;
  background: var(--card-bg);
  border: 1px solid var(--accent-color);
  border-left: 4px solid var(--accent-color);
  border-radius: 6px;
  box-shadow: var(--shadow);
  display: none;
  z-index: 1000;
  max-width: 400px;
}

.toast.error { border-color: var(--danger-color); }
.toast.success { border-color: var(--success-color); }

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 999;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: var(--bg-color);
  border-radius: 8px;
  padding: 24px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.modal-title { font-size: 20px; font-weight: 600; }

.close-modal {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--text-color);
}

.template-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
  margin: 16px 0;
}

.template-card {
  padding: 20px;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  cursor: pointer;
  text-align: center;
  transition: all 0.2s;
}

.template-card:hover { border-color: var(--accent-color); background: var(--hover-color); }
.template-card.selected { border-color: var(--accent-color); background: var(--accent-color); color: white; }

.text-right { text-align: right; }
.text-center { text-align: center; }
.mt-2 { margin-top: 20px; }
.mb-2 { margin-bottom: 20px; }
.hidden { display: none; }
.balanced { color: var(--success-color); font-weight: 600; }
.unbalanced { color: var(--danger-color); font-weight: 600; }

@media print {
  body { background: white !important; color: black !important; }
  .sidebar, .topbar, .btn, .modal { display: none !important; }
  .card { border: 1px solid #ddd !important; box-shadow: none !important; }
}

@media (max-width: 768px) {
  .sidebar { width: 200px; }
  .stats { grid-template-columns: 1fr; }
  .form-group { flex-direction: column; align-items: flex-start; }
  .form-group label { min-width: auto; }
}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">üíö LEDGIOX</div>
    <nav class="nav">
      <button class="nav-item active" data-view="dashboard">üìä Dashboard</button>
      <button class="nav-item" data-view="accounts">üìñ Chart of Accounts</button>
      <button class="nav-item" data-view="journal">üìù Journal Entry</button>
      <button class="nav-item" data-view="bulk">üìã Bulk Journal</button>
      <button class="nav-item" data-view="sales">üí∞ Sales & Invoices</button>
      <button class="nav-item" data-view="purchases">üõí Purchases & Bills</button>
      <button class="nav-item" data-view="payments">üí≥ Payments</button>
      <button class="nav-item" data-view="customers">üë• Customers</button>
      <button class="nav-item" data-view="suppliers">üè≠ Suppliers</button>
      <button class="nav-item" data-view="inventory">üì¶ Inventory</button>
      <button class="nav-item" data-view="reports">üìà Reports</button>
      <button class="nav-item" data-view="settings">‚öôÔ∏è Settings</button>
    </nav>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="topbar-left">
        <span id="companyName" style="font-weight: 600;">No Company Loaded</span>
        <span id="currencyDisplay" style="font-size: 13px; opacity: 0.7;"></span>
      </div>
      <div class="topbar-right">
        <button class="btn btn-small" id="btnNewCompany">New Company</button>
        <button class="btn btn-small" id="btnImport">Import</button>
        <button class="btn btn-small" id="btnExport">Export</button>
        <button class="btn btn-small" id="btnSave">Save</button>
        <button class="btn btn-small" id="themeToggle">üåô</button>
        <input type="file" id="fileInput" accept=".xlsx" style="display:none">
      </div>
    </div>

    <div class="content" id="content"></div>
  </main>
</div>

<div id="toast" class="toast"></div>

<!-- Modals -->
<div id="newCompanyModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Create New Company</h2>
      <button class="close-modal">&times;</button>
    </div>
    <div class="form-group">
      <label>Company Name:</label>
      <input type="text" id="newCompanyName" placeholder="My Company Pvt Ltd">
    </div>
    <div class="form-group">
      <label>Currency:</label>
      <select id="newCurrency">
        <option value="INR">INR - ‚Çπ Indian Rupee</option>
        <option value="USD">USD - $ US Dollar</option>
        <option value="EUR">EUR - ‚Ç¨ Euro</option>
        <option value="GBP">GBP - ¬£ British Pound</option>
        <option value="AED">AED - ÿØ.ÿ• UAE Dirham</option>
      </select>
    </div>
    <div class="form-group">
      <label>Fiscal Year Start:</label>
      <input type="date" id="fiscalYearStart">
    </div>
    <div class="form-group">
      <label>Template:</label>
    </div>
    <div class="template-grid">
      <div class="template-card" data-template="trading">
        <div style="font-size: 32px;">üõí</div>
        <div style="font-weight: 600; margin-top: 8px;">Trading</div>
      </div>
      <div class="template-card" data-template="service">
        <div style="font-size: 32px;">üíº</div>
        <div style="font-weight: 600; margin-top: 8px;">Service</div>
      </div>
      <div class="template-card" data-template="manufacturing">
        <div style="font-size: 32px;">üè≠</div>
        <div style="font-weight: 600; margin-top: 8px;">Manufacturing</div>
      </div>
    </div>
    <button class="btn btn-primary" id="createCompanyBtn" style="width: 100%; margin-top: 20px;">Create Company</button>
  </div>
</div>

<script>
/* ============================================================
   CONSTANTS & GLOBALS
   ============================================================ */
const MAX_JE_ROWS = 800000;
const VERSION = 'LEDGIOX MVP v2';

let WB = null;
let DATA = {
  settings: { companyName: '', currency: 'INR', fiscalYearStart: '', inventoryMethod: 'FIFO', backupEnabled: true },
  accounts: [],
  journalEntries: [],
  customers: [],
  suppliers: [],
  inventory: [],
  invoices: [],
  bills: [],
  payments: []
};

let currentView = 'dashboard';
let selectedTemplate = 'trading';
let journalLines = [];
let bulkJournalLines = [];

const CURRENCY_SYMBOLS = {
  INR: '‚Çπ', USD: '$', EUR: '‚Ç¨', GBP: '¬£', AED: 'ÿØ.ÿ•', JPY: '¬•', AUD: 'A$', CAD: 'C$'
};

/* ============================================================
   CHART OF ACCOUNTS TEMPLATES
   ============================================================ */
const TEMPLATES = {
  trading: [
    { name: 'Cash', type: 'Asset', openingBalance: 0 },
    { name: 'Bank', type: 'Asset', openingBalance: 0 },
    { name: 'Accounts Receivable', type: 'Asset', openingBalance: 0 },
    { name: 'Inventory', type: 'Asset', openingBalance: 0 },
    { name: 'Accounts Payable', type: 'Liability', openingBalance: 0 },
    { name: 'Owner Equity', type: 'Equity', openingBalance: 0 },
    { name: 'Sales Revenue', type: 'Income', openingBalance: 0 },
    { name: 'Cost of Goods Sold', type: 'Expense', openingBalance: 0 },
    { name: 'Purchases', type: 'Expense', openingBalance: 0 },
    { name: 'Rent Expense', type: 'Expense', openingBalance: 0 },
    { name: 'Utilities Expense', type: 'Expense', openingBalance: 0 },
    { name: 'Salaries Expense', type: 'Expense', openingBalance: 0 }
  ],
  service: [
    { name: 'Cash', type: 'Asset', openingBalance: 0 },
    { name: 'Bank', type: 'Asset', openingBalance: 0 },
    { name: 'Accounts Receivable', type: 'Asset', openingBalance: 0 },
    { name: 'Office Equipment', type: 'Asset', openingBalance: 0 },
    { name: 'Accounts Payable', type: 'Liability', openingBalance: 0 },
    { name: 'Owner Equity', type: 'Equity', openingBalance: 0 },
    { name: 'Service Revenue', type: 'Income', openingBalance: 0 },
    { name: 'Consulting Revenue', type: 'Income', openingBalance: 0 },
    { name: 'Salaries Expense', type: 'Expense', openingBalance: 0 },
    { name: 'Rent Expense', type: 'Expense', openingBalance: 0 },
    { name: 'Marketing Expense', type: 'Expense', openingBalance: 0 },
    { name: 'Office Supplies', type: 'Expense', openingBalance: 0 }
  ],
  manufacturing: [
    { name: 'Cash', type: 'Asset', openingBalance: 0 },
    { name: 'Bank', type: 'Asset', openingBalance: 0 },
    { name: 'Accounts Receivable', type: 'Asset', openingBalance: 0 },
    { name: 'Raw Materials', type: 'Asset', openingBalance: 0 },
    { name: 'Work in Progress', type: 'Asset', openingBalance: 0 },
    { name: 'Finished Goods', type: 'Asset', openingBalance: 0 },
    { name: 'Machinery', type: 'Asset', openingBalance: 0 },
    { name: 'Accounts Payable', type: 'Liability', openingBalance: 0 },
    { name: 'Owner Equity', type: 'Equity', openingBalance: 0 },
    { name: 'Sales Revenue', type: 'Income', openingBalance: 0 },
    { name: 'Direct Labor', type: 'Expense', openingBalance: 0 },
    { name: 'Manufacturing Overhead', type: 'Expense', openingBalance: 0 },
    { name: 'Factory Rent', type: 'Expense', openingBalance: 0 }
  ]
};

/* ============================================================
   UTILITY FUNCTIONS
   ============================================================ */
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }

function toast(msg, type = 'success') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `toast ${type}`;
  el.style.display = 'block';
  setTimeout(() => el.style.display = 'none', 3000);
}

function formatCurrency(amount) {
  const symbol = CURRENCY_SYMBOLS[DATA.settings.currency] || DATA.settings.currency;
  return `${symbol} ${parseFloat(amount || 0).toFixed(2)}`;
}

function parseAmount(str) {
  return parseFloat(String(str).replace(/[^\d.-]/g, '')) || 0;
}

/* ============================================================
   THEME TOGGLE
   ============================================================ */
function initTheme() {
  const savedTheme = localStorage.getItem('ledgiox-theme') || 'light';
  document.body.setAttribute('data-theme', savedTheme);
  document.getElementById('themeToggle').textContent = savedTheme === 'dark' ? 'üåû' : 'üåô';
}

document.getElementById('themeToggle').addEventListener('click', () => {
  const current = document.body.getAttribute('data-theme') || 'light';
  const next = current === 'light' ? 'dark' : 'light';
  document.body.setAttribute('data-theme', next);
  localStorage.setItem('ledgiox-theme', next);
  document.getElementById('themeToggle').textContent = next === 'dark' ? 'üåû' : 'üåô';
});

/* ============================================================
   WORKBOOK FUNCTIONS
   ============================================================ */
function createWorkbook() {
  WB = XLSX.utils.book_new();
  
  const settingsData = [
    { Key: 'CompanyName', Value: DATA.settings.companyName },
    { Key: 'Currency', Value: DATA.settings.currency },
    { Key: 'FiscalYearStart', Value: DATA.settings.fiscalYearStart },
    { Key: 'InventoryMethod', Value: DATA.settings.inventoryMethod },
    { Key: 'BackupEnabled', Value: DATA.settings.backupEnabled }
  ];
  
  XLSX.utils.book_append_sheet(WB, XLSX.utils.json_to_sheet(settingsData), 'Settings');
  XLSX.utils.book_append_sheet(WB, XLSX.utils.json_to_sheet(DATA.accounts), 'ChartOfAccounts');
  XLSX.utils.book_append_sheet(WB, XLSX.utils.json_to_sheet([]), 'JournalEntries_1');
  XLSX.utils.book_append_sheet(WB, XLSX.utils.json_to_sheet(DATA.customers), 'Customers');
  XLSX.utils.book_append_sheet(WB, XLSX.utils.json_to_sheet(DATA.suppliers), 'Suppliers');
  XLSX.utils.book_append_sheet(WB, XLSX.utils.json_to_sheet(DATA.inventory), 'Inventory');
  
  toast('Workbook created successfully');
}

function saveWorkbook() {
  if (!WB) {
    toast('No workbook to save', 'error');
    return;
  }

  // Backup if enabled
  if (DATA.settings.backupEnabled) {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
    const backupName = `${DATA.settings.companyName}_Books_${timestamp}.xlsx`;
    XLSX.writeFile(WB, backupName);
  }

  // Remove old journal sheets
  Object.keys(WB.Sheets).forEach(name => {
    if (name.startsWith('JournalEntries')) {
      delete WB.Sheets[name];
    }
  });

  // Split journals into sheets
  for (let i = 0; i < DATA.journalEntries.length; i += MAX_JE_ROWS) {
    const chunk = DATA.journalEntries.slice(i, i + MAX_JE_ROWS);
    const sheetNum = Math.floor(i / MAX_JE_ROWS) + 1;
    XLSX.utils.book_append_sheet(WB, XLSX.utils.json_to_sheet(chunk), `JournalEntries_${sheetNum}`);
  }

  // Update other sheets
  WB.Sheets['ChartOfAccounts'] = XLSX.utils.json_to_sheet(DATA.accounts);
  WB.Sheets['Customers'] = XLSX.utils.json_to_sheet(DATA.customers);
  WB.Sheets['Suppliers'] = XLSX.utils.json_to_sheet(DATA.suppliers);
  WB.Sheets['Inventory'] = XLSX.utils.json_to_sheet(DATA.inventory);

  const filename = `${DATA.settings.companyName}_Books.xlsx`;
  XLSX.writeFile(WB, filename);
  toast('Workbook saved successfully');
}

function loadWorkbook(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = new Uint8Array(e.target.result);
      WB = XLSX.read(data, { type: 'array' });

      // Load settings
      const settingsSheet = WB.Sheets['Settings'];
      if (settingsSheet) {
        const settings = XLSX.utils.sheet_to_json(settingsSheet);
        settings.forEach(s => {
          if (s.Key === 'CompanyName') DATA.settings.companyName = s.Value;
          if (s.Key === 'Currency') DATA.settings.currency = s.Value;
          if (s.Key === 'FiscalYearStart') DATA.settings.fiscalYearStart = s.Value;
          if (s.Key === 'InventoryMethod') DATA.settings.inventoryMethod = s.Value;
          if (s.Key === 'BackupEnabled') DATA.settings.backupEnabled = s.Value;
        });
      }

      // Load accounts
      DATA.accounts = WB.Sheets['ChartOfAccounts'] ? XLSX.utils.sheet_to_json(WB.Sheets['ChartOfAccounts']) : [];

      // Load customers
      DATA.customers = WB.Sheets['Customers'] ? XLSX.utils.sheet_to_json(WB.Sheets['Customers']) : [];

      // Load suppliers
      DATA.suppliers = WB.Sheets['Suppliers'] ? XLSX.utils.sheet_to_json(WB.Sheets['Suppliers']) : [];

      // Load inventory
      DATA.inventory = WB.Sheets['Inventory'] ? XLSX.utils.sheet_to_json(WB.Sheets['Inventory']) : [];

      // Load journal entries (merge all sheets)
      DATA.journalEntries = [];
      Object.keys(WB.Sheets).forEach(sheetName => {
        if (sheetName.startsWith('JournalEntries')) {
          const entries = XLSX.utils.sheet_to_json(WB.Sheets[sheetName]);
          DATA.journalEntries.push(...entries);
        }
      });

      updateUI();
      renderView(currentView);
      toast('Workbook loaded successfully');
    } catch (err) {
      toast('Error loading workbook: ' + err.message, 'error');
    }
  };
  reader.readAsArrayBuffer(file);
}

/* ============================================================
   UI FUNCTIONS
   ============================================================ */
function updateUI() {
  document.getElementById('companyName').textContent = DATA.settings.companyName || 'No Company';
  document.getElementById('currencyDisplay').textContent = DATA.settings.currency ? `(${DATA.settings.currency})` : '';
}

function renderView(view) {
  currentView = view;
  
  // Update nav active state
  document.querySelectorAll('.nav-item').forEach(item => {
    item.classList.toggle('active', item.dataset.view === view);
  });

  const content = document.getElementById('content');
  
  switch(view) {
    case 'dashboard': renderDashboard(content); break;
    case 'accounts': renderAccounts(content); break;
    case 'journal': renderJournal(content); break;
    case 'bulk': renderBulkJournal(content); break;
    case 'sales': renderSales(content); break;
    case 'purchases': renderPurchases(content); break;
    case 'payments': renderPayments(content); break;
    case 'customers': renderCustomers(content); break;
    case 'suppliers': renderSuppliers(content); break;
    case 'inventory': renderInventory(content); break;
    case 'reports': renderReports(content); break;
    case 'settings': renderSettings(content); break;
    default: content.innerHTML = '<div class="card">View not found</div>';
  }
}

/* ============================================================
   DASHBOARD VIEW
   ============================================================ */
function renderDashboard(container) {
  const cash = getAccountBalance('Cash') + getAccountBalance('Bank');
  const ar = getAccountBalance('Accounts Receivable');
  const ap = getAccountBalance('Accounts Payable');
  
  const recentEntries = DATA.journalEntries.slice(-5).reverse();

  container.innerHTML = `
    <div class="stats">
      <div class="stat-card">
        <div class="stat-label">Cash & Bank</div>
        <div class="stat-value">${formatCurrency(cash)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Accounts Receivable</div>
        <div class="stat-value">${formatCurrency(ar)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Accounts Payable</div>
        <div class="stat-value">${formatCurrency(ap)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Accounts</div>
        <div class="stat-value">${DATA.accounts.length}</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Recent Journal Entries</div>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Voucher No</th>
            <th>Description</th>
            <th>Module</th>
            <th class="text-right">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${recentEntries.map(entry => `
            <tr>
              <td>${entry.Date || ''}</td>
              <td>${entry.VoucherNo || ''}</td>
              <td>${entry.Description || ''}</td>
              <td>${entry.Module || 'Manual'}</td>
              <td class="text-right">${formatCurrency(entry.Debit || entry.Credit)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      ${recentEntries.length === 0 ? '<p class="text-center" style="padding: 20px; opacity: 0.6;">No journal entries yet</p>' : ''}
    </div>

    <div class="card">
      <div class="card-title">Quick Stats</div>
      <p>üìä Total Journal Entries: <strong>${DATA.journalEntries.length}</strong></p>
      <p>üë• Customers: <strong>${DATA.customers.length}</strong></p>
      <p>üè≠ Suppliers: <strong>${DATA.suppliers.length}</strong></p>
      <p>üì¶ Inventory Items: <strong>${DATA.inventory.length}</strong></p>
    </div>
  `;
}

/* ============================================================
   CHART OF ACCOUNTS VIEW
   ============================================================ */
function renderAccounts(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Chart of Accounts</div>
      
      <div class="form-group">
        <input type="text" id="accName" placeholder="Account name" style="flex: 2;">
        <select id="accType">
          <option value="Asset">Asset</option>
          <option value="Liability">Liability</option>
          <option value="Equity">Equity</option>
          <option value="Income">Income</option>
          <option value="Expense">Expense</option>
        </select>
        <input type="number" id="accOpeningBalance" placeholder="Opening balance" step="0.01">
        <button class="btn btn-primary" onclick="addAccount()">Add Account</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th class="text-right">Opening Balance</th>
            <th class="text-right">Current Balance</th>
            <th>Notes</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          ${DATA.accounts.map((acc, idx) => `
            <tr>
              <td>${acc.Name}</td>
              <td>${acc.Type}</td>
              <td class="text-right">${formatCurrency(acc.OpeningBalance)}</td>
              <td class="text-right">${formatCurrency(getAccountBalance(acc.Name))}</td>
              <td>${acc.Notes || ''}</td>
              <td class="text-center">
                <button class="btn btn-small btn-danger" onclick="deleteAccount(${idx})">Delete</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      ${DATA.accounts.length === 0 ? '<p class="text-center" style="padding: 20px; opacity: 0.6;">No accounts yet. Add your first account above.</p>' : ''}
    </div>
  `;
}

function addAccount() {
  const name = document.getElementById('accName').value.trim();
  const type = document.getElementById('accType').value;
  const openingBalance = parseFloat(document.getElementById('accOpeningBalance').value) || 0;

  if (!name) {
    toast('Please enter account name', 'error');
    return;
  }

  DATA.accounts.push({
    Name: name,
    Type: type,
    OpeningBalance: openingBalance,
    Notes: ''
  });

  toast('Account added successfully');
  renderView('accounts');
}

function deleteAccount(idx) {
  const account = DATA.accounts[idx];
  const used = DATA.journalEntries.some(e => e.Account === account.Name);
  
  if (used) {
    toast('Cannot delete account with transaction history', 'error');
    return;
  }

  if (confirm(`Delete account "${account.Name}"?`)) {
    DATA.accounts.splice(idx, 1);
    toast('Account deleted');
    renderView('accounts');
  }
}

function getAccountBalance(accountName) {
  const account = DATA.accounts.find(a => a.Name === accountName);
  const opening = account ? (account.OpeningBalance || 0) : 0;
  
  let balance = opening;
  DATA.journalEntries.forEach(entry => {
    if (entry.Account === accountName) {
      const debit = parseFloat(entry.Debit) || 0;
      const credit = parseFloat(entry.Credit) || 0;
      
      if (account && (account.Type === 'Asset' || account.Type === 'Expense')) {
        balance += debit - credit;
      } else {
        balance += credit - debit;
      }
    }
  });
  
  return balance;
}

/* ============================================================
   JOURNAL ENTRY VIEW
   ============================================================ */
function renderJournal(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Journal Entry</div>
      
      <div class="form-group">
        <label>Date:</label>
        <input type="date" id="jeDate" value="${new Date().toISOString().split('T')[0]}">
        <label>Voucher No:</label>
        <input type="text" id="jeVoucherNo" placeholder="Auto-generated">
        <label>Description:</label>
        <input type="text" id="jeDescription" placeholder="Journal description" style="flex: 2;">
      </div>

      <button class="btn" onclick="addJournalLine()">+ Add Line</button>
      
      <table id="journalLinesTable" class="mt-2">
        <thead>
          <tr>
            <th>Account</th>
            <th class="text-right">Debit</th>
            <th class="text-right">Credit</th>
            <th>Customer</th>
            <th>Supplier</th>
            <th>Description</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>
        <tbody id="journalLinesTBody"></tbody>
        <tfoot>
          <tr>
            <th>Total</th>
            <th class="text-right" id="totalDebit">0.00</th>
            <th class="text-right" id="totalCredit">0.00</th>
            <th colspan="4"></th>
          </tr>
        </tfoot>
      </table>

      <div class="form-group mt-2">
        <button class="btn btn-primary" onclick="postJournal()">Post Journal Entry</button>
        <button class="btn" onclick="clearJournal()">Clear</button>
        <span id="balanceStatus" style="margin-left: 20px;"></span>
      </div>
    </div>
  `;
  
  renderJournalLines();
}

function addJournalLine() {
  journalLines.push({
    id: uid(),
    account: '',
    debit: 0,
    credit: 0,
    customer: '',
    supplier: '',
    description: ''
  });
  renderJournalLines();
}

function renderJournalLines() {
  const tbody = document.getElementById('journalLinesTBody');
  if (!tbody) return;

  tbody.innerHTML = journalLines.map((line, idx) => `
    <tr>
      <td>
        <select onchange="updateJournalLine(${idx}, 'account', this.value)">
          <option value="">-- Select Account --</option>
          ${DATA.accounts.map(acc => `
            <option value="${acc.Name}" ${line.account === acc.Name ? 'selected' : ''}>${acc.Name}</option>
          `).join('')}
        </select>
      </td>
      <td><input type="number" step="0.01" value="${line.debit}" onchange="updateJournalLine(${idx}, 'debit', this.value)"></td>
      <td><input type="number" step="0.01" value="${line.credit}" onchange="updateJournalLine(${idx}, 'credit', this.value)"></td>
      <td>
        <select onchange="updateJournalLine(${idx}, 'customer', this.value)">
          <option value="">-- None --</option>
          ${DATA.customers.map(c => `
            <option value="${c.Name}" ${line.customer === c.Name ? 'selected' : ''}>${c.Name}</option>
          `).join('')}
        </select>
      </td>
      <td>
        <select onchange="updateJournalLine(${idx}, 'supplier', this.value)">
          <option value="">-- None --</option>
          ${DATA.suppliers.map(s => `
            <option value="${s.Name}" ${line.supplier === s.Name ? 'selected' : ''}>${s.Name}</option>
          `).join('')}
        </select>
      </td>
      <td><input type="text" value="${line.description}" onchange="updateJournalLine(${idx}, 'description', this.value)"></td>
      <td class="text-center"><button class="btn btn-small btn-danger" onclick="removeJournalLine(${idx})">Delete</button></td>
    </tr>
  `).join('');

  updateJournalTotals();
}

function updateJournalLine(idx, field, value) {
  if (field === 'debit' || field === 'credit') {
    journalLines[idx][field] = parseFloat(value) || 0;
  } else {
    journalLines[idx][field] = value;
  }
  updateJournalTotals();
}

function removeJournalLine(idx) {
  journalLines.splice(idx, 1);
  renderJournalLines();
}

function updateJournalTotals() {
  const totalDebit = journalLines.reduce((sum, line) => sum + (parseFloat(line.debit) || 0), 0);
  const totalCredit = journalLines.reduce((sum, line) => sum + (parseFloat(line.credit) || 0), 0);
  
  const debitEl = document.getElementById('totalDebit');
  const creditEl = document.getElementById('totalCredit');
  const statusEl = document.getElementById('balanceStatus');
  
  if (debitEl) debitEl.textContent = totalDebit.toFixed(2);
  if (creditEl) creditEl.textContent = totalCredit.toFixed(2);
  
  if (statusEl) {
    const diff = Math.abs(totalDebit - totalCredit);
    if (diff < 0.01) {
      statusEl.innerHTML = '<span class="balanced">‚úì Balanced</span>';
    } else {
      statusEl.innerHTML = '<span class="unbalanced">‚úó Not Balanced</span>';
    }
  }
}

function postJournal() {
  const date = document.getElementById('jeDate').value;
  const voucherNo = document.getElementById('jeVoucherNo').value || `JE-${Date.now()}`;
  const description = document.getElementById('jeDescription').value;

  if (!date) {
    toast('Please select a date', 'error');
    return;
  }

  if (journalLines.length === 0) {
    toast('Please add at least one line', 'error');
    return;
  }

  const totalDebit = journalLines.reduce((sum, line) => sum + (parseFloat(line.debit) || 0), 0);
  const totalCredit = journalLines.reduce((sum, line) => sum + (parseFloat(line.credit) || 0), 0);

  if (Math.abs(totalDebit - totalCredit) > 0.01) {
    toast('Journal entry is not balanced', 'error');
    return;
  }

  const entryID = uid();
  journalLines.forEach((line, idx) => {
    DATA.journalEntries.push({
      EntryID: entryID,
      Date: date,
      VoucherNo: voucherNo,
      LineNumber: idx + 1,
      Account: line.account,
      Debit: line.debit || 0,
      Credit: line.credit || 0,
      Customer: line.customer || '',
      Supplier: line.supplier || '',
      ItemCode: '',
      Description: line.description || description,
      Module: 'Journal'
    });
  });

  toast('Journal entry posted successfully');
  clearJournal();
  renderView('journal');
}

function clearJournal() {
  journalLines = [];
  document.getElementById('jeVoucherNo').value = '';
  document.getElementById('jeDescription').value = '';
  renderJournalLines();
}

/* ============================================================
   BULK JOURNAL VIEW
   ============================================================ */
function renderBulkJournal(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Bulk Multi-Date Journal Entry</div>
      
      <div class="form-group">
        <button class="btn" onclick="addBulkLine()">+ Add Line</button>
        <button class="btn btn-primary" onclick="postBulkJournal()">Post All Entries</button>
        <button class="btn" onclick="clearBulkJournal()">Clear</button>
        <label>Import CSV:</label>
        <input type="file" id="csvImportFile" accept=".csv" onchange="importCSV(this.files[0])">
      </div>

      <table id="bulkJournalTable" class="mt-2">
        <thead>
          <tr>
            <th>Date</th>
            <th>Account</th>
            <th class="text-right">Debit</th>
            <th class="text-right">Credit</th>
            <th>Customer</th>
            <th>Supplier</th>
            <th>Description</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>
        <tbody id="bulkJournalTBody"></tbody>
      </table>
      ${bulkJournalLines.length === 0 ? '<p class="text-center" style="padding: 20px; opacity: 0.6;">No bulk entries. Add lines or import CSV.</p>' : ''}
    </div>
  `;
  
  renderBulkLines();
}

function addBulkLine() {
  bulkJournalLines.push({
    id: uid(),
    date: new Date().toISOString().split('T')[0],
    account: '',
    debit: 0,
    credit: 0,
    customer: '',
    supplier: '',
    description: ''
  });
  renderBulkLines();
}

function renderBulkLines() {
  const tbody = document.getElementById('bulkJournalTBody');
  if (!tbody) return;

  tbody.innerHTML = bulkJournalLines.map((line, idx) => `
    <tr>
      <td><input type="date" value="${line.date}" onchange="updateBulkLine(${idx}, 'date', this.value)" style="width: 150px;"></td>
      <td>
        <select onchange="updateBulkLine(${idx}, 'account', this.value)">
          <option value="">-- Select --</option>
          ${DATA.accounts.map(acc => `
            <option value="${acc.Name}" ${line.account === acc.Name ? 'selected' : ''}>${acc.Name}</option>
          `).join('')}
        </select>
      </td>
      <td><input type="number" step="0.01" value="${line.debit}" onchange="updateBulkLine(${idx}, 'debit', this.value)"></td>
      <td><input type="number" step="0.01" value="${line.credit}" onchange="updateBulkLine(${idx}, 'credit', this.value)"></td>
      <td>
        <select onchange="updateBulkLine(${idx}, 'customer', this.value)">
          <option value="">-- None --</option>
          ${DATA.customers.map(c => `<option value="${c.Name}" ${line.customer === c.Name ? 'selected' : ''}>${c.Name}</option>`).join('')}
        </select>
      </td>
      <td>
        <select onchange="updateBulkLine(${idx}, 'supplier', this.value)">
          <option value="">-- None --</option>
          ${DATA.suppliers.map(s => `<option value="${s.Name}" ${line.supplier === s.Name ? 'selected' : ''}>${s.Name}</option>`).join('')}
        </select>
      </td>
      <td><input type="text" value="${line.description}" onchange="updateBulkLine(${idx}, 'description', this.value)"></td>
      <td class="text-center"><button class="btn btn-small btn-danger" onclick="removeBulkLine(${idx})">Delete</button></td>
    </tr>
  `).join('');
}

function updateBulkLine(idx, field, value) {
  if (field === 'debit' || field === 'credit') {
    bulkJournalLines[idx][field] = parseFloat(value) || 0;
  } else {
    bulkJournalLines[idx][field] = value;
  }
}

function removeBulkLine(idx) {
  bulkJournalLines.splice(idx, 1);
  renderBulkLines();
}

function postBulkJournal() {
  if (bulkJournalLines.length === 0) {
    toast('No lines to post', 'error');
    return;
  }

  // Group by date
  const grouped = {};
  bulkJournalLines.forEach(line => {
    if (!grouped[line.date]) grouped[line.date] = [];
    grouped[line.date].push(line);
  });

  let posted = 0;
  Object.keys(grouped).forEach(date => {
    const lines = grouped[date];
    const totalDebit = lines.reduce((sum, l) => sum + (parseFloat(l.debit) || 0), 0);
    const totalCredit = lines.reduce((sum, l) => sum + (parseFloat(l.credit) || 0), 0);

    if (Math.abs(totalDebit - totalCredit) > 0.01) {
      toast(`Entries for ${date} not balanced. Skipped.`, 'error');
      return;
    }

    const entryID = uid();
    const voucherNo = `BULK-${date}-${entryID.slice(0, 6)}`;

    lines.forEach((line, idx) => {
      DATA.journalEntries.push({
        EntryID: entryID,
        Date: date,
        VoucherNo: voucherNo,
        LineNumber: idx + 1,
        Account: line.account,
        Debit: line.debit || 0,
        Credit: line.credit || 0,
        Customer: line.customer || '',
        Supplier: line.supplier || '',
        ItemCode: '',
        Description: line.description,
        Module: 'BulkJournal'
      });
    });

    posted++;
  });

  toast(`Posted ${posted} journal entries`);
  clearBulkJournal();
  renderView('bulk');
}

function clearBulkJournal() {
  bulkJournalLines = [];
  renderBulkLines();
}

function importCSV(file) {
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const text = e.target.result;
    const rows = text.split('\n').map(r => r.split(','));
    const headers = rows[0].map(h => h.trim());
    
    for (let i = 1; i < rows.length; i++) {
      if (rows[i].length < headers.length) continue;
      
      const obj = {};
      headers.forEach((h, idx) => {
        obj[h] = rows[i][idx] ? rows[i][idx].trim() : '';
      });

      bulkJournalLines.push({
        id: uid(),
        date: obj.Date || new Date().toISOString().split('T')[0],
        account: obj.Account || '',
        debit: parseFloat(obj.Debit) || 0,
        credit: parseFloat(obj.Credit) || 0,
        customer: obj.Customer || '',
        supplier: obj.Supplier || '',
        description: obj.Description || ''
      });
    }
    
    renderBulkLines();
    toast('CSV imported successfully');
  };
  reader.readAsText(file);
}

/* ============================================================
   SALES VIEW
   ============================================================ */
function renderSales(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Sales & Invoices</div>
      <p style="opacity: 0.7;">Create sales invoices (Dr: Accounts Receivable, Cr: Sales Revenue)</p>
      
      <div class="form-group">
        <label>Date:</label>
        <input type="date" id="saleDate" value="${new Date().toISOString().split('T')[0]}">
        <label>Customer:</label>
        <select id="saleCustomer">
          <option value="">-- Select Customer --</option>
          ${DATA.customers.map(c => `<option value="${c.Name}">${c.Name}</option>`).join('')}
        </select>
        <label>Amount:</label>
        <input type="number" id="saleAmount" step="0.01" placeholder="Invoice amount">
        <label>Description:</label>
        <input type="text" id="saleDescription" placeholder="Sale description" style="flex: 2;">
      </div>
      
      <button class="btn btn-primary" onclick="postSale()">Create Invoice</button>
    </div>

    <div class="card">
      <div class="card-title">Recent Invoices</div>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Customer</th>
            <th>Description</th>
            <th class="text-right">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${DATA.journalEntries.filter(e => e.Module === 'Sales').slice(-10).reverse().map(entry => `
            <tr>
              <td>${entry.Date}</td>
              <td>${entry.Customer}</td>
              <td>${entry.Description}</td>
              <td class="text-right">${formatCurrency(entry.Debit || entry.Credit)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function postSale() {
  const date = document.getElementById('saleDate').value;
  const customer = document.getElementById('saleCustomer').value;
  const amount = parseFloat(document.getElementById('saleAmount').value);
  const description = document.getElementById('saleDescription').value;

  if (!date || !customer || !amount || amount <= 0) {
    toast('Please fill all required fields', 'error');
    return;
  }

  const arAccount = DATA.accounts.find(a => a.Name.includes('Receivable'));
  const salesAccount = DATA.accounts.find(a => a.Name.includes('Sales') || a.Name.includes('Revenue'));

  if (!arAccount || !salesAccount) {
    toast('Required accounts (AR/Sales) not found', 'error');
    return;
  }

  const entryID = uid();
  const voucherNo = `INV-${date.replace(/-/g, '')}-${entryID.slice(0, 6)}`;

  DATA.journalEntries.push({
    EntryID: entryID,
    Date: date,
    VoucherNo: voucherNo,
    LineNumber: 1,
    Account: arAccount.Name,
    Debit: amount,
    Credit: 0,
    Customer: customer,
    Supplier: '',
    ItemCode: '',
    Description: description,
    Module: 'Sales'
  });

  DATA.journalEntries.push({
    EntryID: entryID,
    Date: date,
    VoucherNo: voucherNo,
    LineNumber: 2,
    Account: salesAccount.Name,
    Debit: 0,
    Credit: amount,
    Customer: customer,
    Supplier: '',
    ItemCode: '',
    Description: description,
    Module: 'Sales'
  });

  toast('Invoice created successfully');
  renderView('sales');
}

/* ============================================================
   PURCHASES VIEW
   ============================================================ */
function renderPurchases(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Purchases & Bills</div>
      <p style="opacity: 0.7;">Record purchase bills (Dr: Purchases/Inventory, Cr: Accounts Payable)</p>
      
      <div class="form-group">
        <label>Date:</label>
        <input type="date" id="purchaseDate" value="${new Date().toISOString().split('T')[0]}">
        <label>Supplier:</label>
        <select id="purchaseSupplier">
          <option value="">-- Select Supplier --</option>
          ${DATA.suppliers.map(s => `<option value="${s.Name}">${s.Name}</option>`).join('')}
        </select>
        <label>Amount:</label>
        <input type="number" id="purchaseAmount" step="0.01" placeholder="Bill amount">
        <label>Description:</label>
        <input type="text" id="purchaseDescription" placeholder="Purchase description" style="flex: 2;">
      </div>
      
      <button class="btn btn-primary" onclick="postPurchase()">Create Bill</button>
    </div>

    <div class="card">
      <div class="card-title">Recent Bills</div>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Supplier</th>
            <th>Description</th>
            <th class="text-right">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${DATA.journalEntries.filter(e => e.Module === 'Purchase').slice(-10).reverse().map(entry => `
            <tr>
              <td>${entry.Date}</td>
              <td>${entry.Supplier}</td>
              <td>${entry.Description}</td>
              <td class="text-right">${formatCurrency(entry.Debit || entry.Credit)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function postPurchase() {
  const date = document.getElementById('purchaseDate').value;
  const supplier = document.getElementById('purchaseSupplier').value;
  const amount = parseFloat(document.getElementById('purchaseAmount').value);
  const description = document.getElementById('purchaseDescription').value;

  if (!date || !supplier || !amount || amount <= 0) {
    toast('Please fill all required fields', 'error');
    return;
  }

  const purchasesAccount = DATA.accounts.find(a => a.Name.includes('Purchase'));
  const apAccount = DATA.accounts.find(a => a.Name.includes('Payable'));

  if (!purchasesAccount || !apAccount) {
    toast('Required accounts (Purchases/AP) not found', 'error');
    return;
  }

  const entryID = uid();
  const voucherNo = `BILL-${date.replace(/-/g, '')}-${entryID.slice(0, 6)}`;

  DATA.journalEntries.push({
    EntryID: entryID,
    Date: date,
    VoucherNo: voucherNo,
    LineNumber: 1,
    Account: purchasesAccount.Name,
    Debit: amount,
    Credit: 0,
    Customer: '',
    Supplier: supplier,
    ItemCode: '',
    Description: description,
    Module: 'Purchase'
  });

  DATA.journalEntries.push({
    EntryID: entryID,
    Date: date,
    VoucherNo: voucherNo,
    LineNumber: 2,
    Account: apAccount.Name,
    Debit: 0,
    Credit: amount,
    Customer: '',
    Supplier: supplier,
    ItemCode: '',
    Description: description,
    Module: 'Purchase'
  });

  toast('Purchase bill created successfully');
  renderView('purchases');
}

/* ============================================================
   PAYMENTS VIEW
   ============================================================ */
function renderPayments(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Payments</div>
      
      <h3 style="margin-top: 20px;">Receive Payment (from Customer)</h3>
      <div class="form-group">
        <label>Date:</label>
        <input type="date" id="receiveDate" value="${new Date().toISOString().split('T')[0]}">
        <label>Customer:</label>
        <select id="receiveCustomer">
          <option value="">-- Select --</option>
          ${DATA.customers.map(c => `<option value="${c.Name}">${c.Name}</option>`).join('')}
        </select>
        <label>Amount:</label>
        <input type="number" id="receiveAmount" step="0.01">
        <button class="btn btn-primary" onclick="postReceivePayment()">Receive</button>
      </div>

      <h3 style="margin-top: 30px;">Make Payment (to Supplier)</h3>
      <div class="form-group">
        <label>Date:</label>
        <input type="date" id="payDate" value="${new Date().toISOString().split('T')[0]}">
        <label>Supplier:</label>
        <select id="paySupplier">
          <option value="">-- Select --</option>
          ${DATA.suppliers.map(s => `<option value="${s.Name}">${s.Name}</option>`).join('')}
        </select>
        <label>Amount:</label>
        <input type="number" id="payAmount" step="0.01">
        <button class="btn btn-primary" onclick="postMakePayment()">Pay</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Recent Payments</div>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Party</th>
            <th class="text-right">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${DATA.journalEntries.filter(e => e.Module === 'Payment').slice(-15).reverse().map(entry => `
            <tr>
              <td>${entry.Date}</td>
              <td>${entry.Customer ? 'Received' : 'Paid'}</td>
              <td>${entry.Customer || entry.Supplier}</td>
              <td class="text-right">${formatCurrency(entry.Debit || entry.Credit)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function postReceivePayment() {
  const date = document.getElementById('receiveDate').value;
  const customer = document.getElementById('receiveCustomer').value;
  const amount = parseFloat(document.getElementById('receiveAmount').value);

  if (!date || !customer || !amount) {
    toast('Please fill all fields', 'error');
    return;
  }

  const cashAccount = DATA.accounts.find(a => a.Name === 'Cash' || a.Name === 'Bank');
  const arAccount = DATA.accounts.find(a => a.Name.includes('Receivable'));

  const entryID = uid();
  const voucherNo = `RCV-${date.replace(/-/g, '')}-${entryID.slice(0, 6)}`;

  DATA.journalEntries.push({
    EntryID: entryID, Date: date, VoucherNo: voucherNo, LineNumber: 1,
    Account: cashAccount.Name, Debit: amount, Credit: 0,
    Customer: customer, Supplier: '', ItemCode: '',
    Description: `Payment received from ${customer}`, Module: 'Payment'
  });

  DATA.journalEntries.push({
    EntryID: entryID, Date: date, VoucherNo: voucherNo, LineNumber: 2,
    Account: arAccount.Name, Debit: 0, Credit: amount,
    Customer: customer, Supplier: '', ItemCode: '',
    Description: `Payment received from ${customer}`, Module: 'Payment'
  });

  toast('Payment received');
  renderView('payments');
}

function postMakePayment() {
  const date = document.getElementById('payDate').value;
  const supplier = document.getElementById('paySupplier').value;
  const amount = parseFloat(document.getElementById('payAmount').value);

  if (!date || !supplier || !amount) {
    toast('Please fill all fields', 'error');
    return;
  }

  const cashAccount = DATA.accounts.find(a => a.Name === 'Cash' || a.Name === 'Bank');
  const apAccount = DATA.accounts.find(a => a.Name.includes('Payable'));

  const entryID = uid();
  const voucherNo = `PAY-${date.replace(/-/g, '')}-${entryID.slice(0, 6)}`;

  DATA.journalEntries.push({
    EntryID: entryID, Date: date, VoucherNo: voucherNo, LineNumber: 1,
    Account: apAccount.Name, Debit: amount, Credit: 0,
    Customer: '', Supplier: supplier, ItemCode: '',
    Description: `Payment to ${supplier}`, Module: 'Payment'
  });

  DATA.journalEntries.push({
    EntryID: entryID, Date: date, VoucherNo: voucherNo, LineNumber: 2,
    Account: cashAccount.Name, Debit: 0, Credit: amount,
    Customer: '', Supplier: supplier, ItemCode: '',
    Description: `Payment to ${supplier}`, Module: 'Payment'
  });

  toast('Payment made');
  renderView('payments');
}

/* ============================================================
   CUSTOMERS VIEW
   ============================================================ */
function renderCustomers(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Customers</div>
      
      <div class="form-group">
        <input type="text" id="custName" placeholder="Customer name" style="flex: 2;">
        <input type="text" id="custContact" placeholder="Contact person">
        <input type="number" id="custOpeningBalance" placeholder="Opening balance" step="0.01">
        <button class="btn btn-primary" onclick="addCustomer()">Add Customer</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Contact</th>
            <th class="text-right">Opening Balance</th>
            <th class="text-right">Current Balance</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          ${DATA.customers.map((cust, idx) => `
            <tr>
              <td>${cust.Name}</td>
              <td>${cust.Contact || ''}</td>
              <td class="text-right">${formatCurrency(cust.OpeningBalance || 0)}</td>
              <td class="text-right">${formatCurrency(getCustomerBalance(cust.Name))}</td>
              <td class="text-center">
                <button class="btn btn-small" onclick="viewCustomerStatement('${cust.Name}')">Statement</button>
                <button class="btn btn-small btn-danger" onclick="deleteCustomer(${idx})">Delete</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function addCustomer() {
  const name = document.getElementById('custName').value.trim();
  const contact = document.getElementById('custContact').value.trim();
  const openingBalance = parseFloat(document.getElementById('custOpeningBalance').value) || 0;

  if (!name) {
    toast('Please enter customer name', 'error');
    return;
  }

  DATA.customers.push({
    ID: uid(),
    Name: name,
    Contact: contact,
    OpeningBalance: openingBalance
  });

  toast('Customer added');
  renderView('customers');
}

function deleteCustomer(idx) {
  if (confirm('Delete this customer?')) {
    DATA.customers.splice(idx, 1);
    toast('Customer deleted');
    renderView('customers');
  }
}

function getCustomerBalance(customerName) {
  const customer = DATA.customers.find(c => c.Name === customerName);
  let balance = customer ? (customer.OpeningBalance || 0) : 0;

  DATA.journalEntries.forEach(entry => {
    if (entry.Customer === customerName) {
      balance += (parseFloat(entry.Debit) || 0) - (parseFloat(entry.Credit) || 0);
    }
  });

  return balance;
}

function viewCustomerStatement(customerName) {
  alert(`Customer Statement for ${customerName}\n\nBalance: ${formatCurrency(getCustomerBalance(customerName))}\n\n(Full aging report coming soon)`);
}

/* ============================================================
   SUPPLIERS VIEW
   ============================================================ */
function renderSuppliers(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Suppliers</div>
      
      <div class="form-group">
        <input type="text" id="suppName" placeholder="Supplier name" style="flex: 2;">
        <input type="text" id="suppContact" placeholder="Contact person">
        <input type="number" id="suppOpeningBalance" placeholder="Opening balance" step="0.01">
        <button class="btn btn-primary" onclick="addSupplier()">Add Supplier</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Contact</th>
            <th class="text-right">Opening Balance</th>
            <th class="text-right">Current Balance</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          ${DATA.suppliers.map((supp, idx) => `
            <tr>
              <td>${supp.Name}</td>
              <td>${supp.Contact || ''}</td>
              <td class="text-right">${formatCurrency(supp.OpeningBalance || 0)}</td>
              <td class="text-right">${formatCurrency(getSupplierBalance(supp.Name))}</td>
              <td class="text-center">
                <button class="btn btn-small" onclick="viewSupplierStatement('${supp.Name}')">Statement</button>
                <button class="btn btn-small btn-danger" onclick="deleteSupplier(${idx})">Delete</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function addSupplier() {
  const name = document.getElementById('suppName').value.trim();
  const contact = document.getElementById('suppContact').value.trim();
  const openingBalance = parseFloat(document.getElementById('suppOpeningBalance').value) || 0;

  if (!name) {
    toast('Please enter supplier name', 'error');
    return;
  }

  DATA.suppliers.push({
    ID: uid(),
    Name: name,
    Contact: contact,
    OpeningBalance: openingBalance
  });

  toast('Supplier added');
  renderView('suppliers');
}

function deleteSupplier(idx) {
  if (confirm('Delete this supplier?')) {
    DATA.suppliers.splice(idx, 1);
    toast('Supplier deleted');
    renderView('suppliers');
  }
}

function getSupplierBalance(supplierName) {
  const supplier = DATA.suppliers.find(s => s.Name === supplierName);
  let balance = supplier ? (supplier.OpeningBalance || 0) : 0;

  DATA.journalEntries.forEach(entry => {
    if (entry.Supplier === supplierName) {
      balance += (parseFloat(entry.Credit) || 0) - (parseFloat(entry.Debit) || 0);
    }
  });

  return balance;
}

function viewSupplierStatement(supplierName) {
  alert(`Supplier Statement for ${supplierName}\n\nBalance: ${formatCurrency(getSupplierBalance(supplierName))}\n\n(Full aging report coming soon)`);
}

/* ============================================================
   INVENTORY VIEW
   ============================================================ */
function renderInventory(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Inventory Management</div>
      
      <div class="form-group">
        <input type="text" id="itemCode" placeholder="Item code">
        <input type="text" id="itemName" placeholder="Item name" style="flex: 2;">
        <input type="text" id="itemCategory" placeholder="Category">
        <input type="number" id="itemQty" placeholder="Opening qty" step="0.01">
        <input type="number" id="itemCost" placeholder="Cost" step="0.01">
        <button class="btn btn-primary" onclick="addInventoryItem()">Add Item</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Category</th>
            <th class="text-right">Qty</th>
            <th class="text-right">Cost</th>
            <th class="text-right">Value</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          ${DATA.inventory.map((item, idx) => {
            const value = (item.CurrentQty || 0) * (item.LastCost || 0);
            return `
              <tr>
                <td>${item.ItemCode}</td>
                <td>${item.ItemName}</td>
                <td>${item.Category || ''}</td>
                <td class="text-right">${(item.CurrentQty || 0).toFixed(2)}</td>
                <td class="text-right">${formatCurrency(item.LastCost)}</td>
                <td class="text-right">${formatCurrency(value)}</td>
                <td class="text-center">
                  <button class="btn btn-small btn-danger" onclick="deleteInventoryItem(${idx})">Delete</button>
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    </div>
  `;
}

function addInventoryItem() {
  const code = document.getElementById('itemCode').value.trim();
  const name = document.getElementById('itemName').value.trim();
  const category = document.getElementById('itemCategory').value.trim();
  const qty = parseFloat(document.getElementById('itemQty').value) || 0;
  const cost = parseFloat(document.getElementById('itemCost').value) || 0;

  if (!code || !name) {
    toast('Please enter code and name', 'error');
    return;
  }

  DATA.inventory.push({
    ItemCode: code,
    ItemName: name,
    Category: category,
    OpeningQty: qty,
    CurrentQty: qty,
    LastCost: cost
  });

  toast('Inventory item added');
  renderView('inventory');
}

function deleteInventoryItem(idx) {
  if (confirm('Delete this item?')) {
    DATA.inventory.splice(idx, 1);
    toast('Item deleted');
    renderView('inventory');
  }
}

/* ============================================================
   REPORTS VIEW
   ============================================================ */
function renderReports(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Financial Reports</div>
      
      <div class="form-group">
        <button class="btn" onclick="generateReport('trial')">Trial Balance</button>
        <button class="btn" onclick="generateReport('pl')">Profit & Loss</button>
        <button class="btn" onclick="generateReport('bs')">Balance Sheet</button>
        <button class="btn" onclick="generateReport('ledger')">General Ledger</button>
      </div>

      <div id="reportOutput" class="mt-2"></div>
    </div>
  `;
}

function generateReport(type) {
  const output = document.getElementById('reportOutput');
  
  if (type === 'trial') {
    let html = '<h3>Trial Balance</h3><table><thead><tr><th>Account</th><th class="text-right">Debit</th><th class="text-right">Credit</th></tr></thead><tbody>';
    
    let totalDebit = 0;
    let totalCredit = 0;
    
    DATA.accounts.forEach(acc => {
      const balance = getAccountBalance(acc.Name);
      const debit = balance >= 0 ? balance : 0;
      const credit = balance < 0 ? -balance : 0;
      
      totalDebit += debit;
      totalCredit += credit;
      
      html += `<tr><td>${acc.Name}</td><td class="text-right">${formatCurrency(debit)}</td><td class="text-right">${formatCurrency(credit)}</td></tr>`;
    });
    
    html += `<tr style="font-weight: bold; border-top: 2px solid;"><td>Total</td><td class="text-right">${formatCurrency(totalDebit)}</td><td class="text-right">${formatCurrency(totalCredit)}</td></tr>`;
    html += '</tbody></table>';
    html += `<button class="btn mt-2" onclick="exportReportExcel('TrialBalance')">Export Excel</button>`;
    html += `<button class="btn mt-2" onclick="window.print()">Print</button>`;
    
    output.innerHTML = html;
  } else if (type === 'pl') {
    let income = 0;
    let expenses = 0;
    
    DATA.accounts.forEach(acc => {
      const balance = getAccountBalance(acc.Name);
      if (acc.Type === 'Income') income += Math.abs(balance);
      if (acc.Type === 'Expense') expenses += Math.abs(balance);
    });
    
    const profit = income - expenses;
    
    let html = `
      <h3>Profit & Loss Statement</h3>
      <table>
        <tbody>
          <tr><td><strong>Income</strong></td><td class="text-right"><strong>${formatCurrency(income)}</strong></td></tr>
          <tr><td><strong>Expenses</strong></td><td class="text-right"><strong>${formatCurrency(expenses)}</strong></td></tr>
          <tr style="border-top: 2px solid;"><td><strong>${profit >= 0 ? 'Net Profit' : 'Net Loss'}</strong></td><td class="text-right"><strong>${formatCurrency(Math.abs(profit))}</strong></td></tr>
        </tbody>
      </table>
      <button class="btn mt-2" onclick="exportReportExcel('ProfitLoss')">Export Excel</button>
      <button class="btn mt-2" onclick="window.print()">Print</button>
    `;
    
    output.innerHTML = html;
  } else if (type === 'bs') {
    let assets = 0;
    let liabilities = 0;
    let equity = 0;
    
    DATA.accounts.forEach(acc => {
      const balance = getAccountBalance(acc.Name);
      if (acc.Type === 'Asset') assets += balance;
      if (acc.Type === 'Liability') liabilities += balance;
      if (acc.Type === 'Equity') equity += balance;
    });
    
    let html = `
      <h3>Balance Sheet</h3>
      <table>
        <tbody>
          <tr><td><strong>Assets</strong></td><td class="text-right"><strong>${formatCurrency(assets)}</strong></td></tr>
          <tr><td><strong>Liabilities</strong></td><td class="text-right"><strong>${formatCurrency(liabilities)}</strong></td></tr>
          <tr><td><strong>Equity</strong></td><td class="text-right"><strong>${formatCurrency(equity)}</strong></td></tr>
          <tr style="border-top: 2px solid;"><td><strong>Total Liabilities + Equity</strong></td><td class="text-right"><strong>${formatCurrency(liabilities + equity)}</strong></td></tr>
        </tbody>
      </table>
      <button class="btn mt-2" onclick="exportReportExcel('BalanceSheet')">Export Excel</button>
      <button class="btn mt-2" onclick="window.print()">Print</button>
    `;
    
    output.innerHTML = html;
  } else if (type === 'ledger') {
    let html = '<h3>General Ledger</h3>';
    html += '<p>Select an account to view ledger:</p>';
    html += '<select id="ledgerAccount" onchange="showLedger(this.value)"><option value="">-- Select Account --</option>';
    DATA.accounts.forEach(acc => {
      html += `<option value="${acc.Name}">${acc.Name}</option>`;
    });
    html += '</select>';
    html += '<div id="ledgerDetails" class="mt-2"></div>';
    
    output.innerHTML = html;
  }
}

function showLedger(accountName) {
  if (!accountName) return;
  
  const entries = DATA.journalEntries.filter(e => e.Account === accountName);
  const details = document.getElementById('ledgerDetails');
  
  let html = `<h4>${accountName} Ledger</h4><table><thead><tr><th>Date</th><th>Voucher</th><th>Description</th><th class="text-right">Debit</th><th class="text-right">Credit</th><th class="text-right">Balance</th></tr></thead><tbody>`;
  
  let balance = 0;
  entries.forEach(entry => {
    const debit = parseFloat(entry.Debit) || 0;
    const credit = parseFloat(entry.Credit) || 0;
    balance += debit - credit;
    
    html += `<tr>
      <td>${entry.Date}</td>
      <td>${entry.VoucherNo}</td>
      <td>${entry.Description}</td>
      <td class="text-right">${formatCurrency(debit)}</td>
      <td class="text-right">${formatCurrency(credit)}</td>
      <td class="text-right">${formatCurrency(balance)}</td>
    </tr>`;
  });
  
  html += '</tbody></table>';
  details.innerHTML = html;
}

function exportReportExcel(reportName) {
  const wb = XLSX.utils.book_new();
  const data = [];
  
  // Extract data from current report display
  const tables = document.querySelectorAll('#reportOutput table');
  if (tables.length > 0) {
    const table = tables[0];
    const rows = table.querySelectorAll('tr');
    rows.forEach(row => {
      const cells = row.querySelectorAll('th, td');
      const rowData = [];
      cells.forEach(cell => rowData.push(cell.textContent));
      data.push(rowData);
    });
  }
  
  const ws = XLSX.utils.aoa_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, reportName);
  XLSX.writeFile(wb, `${reportName}_${new Date().toISOString().split('T')[0]}.xlsx`);
  toast('Report exported');
}

/* ============================================================
   SETTINGS VIEW
   ============================================================ */
function renderSettings(container) {
  container.innerHTML = `
    <div class="card">
      <div class="card-title">Company Settings</div>
      
      <div class="form-group">
        <label>Company Name:</label>
        <input type="text" id="settingsCompanyName" value="${DATA.settings.companyName}">
      </div>
      
      <div class="form-group">
        <label>Currency:</label>
        <select id="settingsCurrency">
          <option value="INR" ${DATA.settings.currency === 'INR' ? 'selected' : ''}>INR - ‚Çπ</option>
          <option value="USD" ${DATA.settings.currency === 'USD' ? 'selected' : ''}>USD - $</option>
          <option value="EUR" ${DATA.settings.currency === 'EUR' ? 'selected' : ''}>EUR - ‚Ç¨</option>
          <option value="GBP" ${DATA.settings.currency === 'GBP' ? 'selected' : ''}>GBP - ¬£</option>
          <option value="AED" ${DATA.settings.currency === 'AED' ? 'selected' : ''}>AED - ÿØ.ÿ•</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Fiscal Year Start:</label>
        <input type="date" id="settingsFiscalYear" value="${DATA.settings.fiscalYearStart}">
      </div>
      
      <div class="form-group">
        <label>Inventory Method:</label>
        <select id="settingsInventoryMethod">
          <option value="FIFO" ${DATA.settings.inventoryMethod === 'FIFO' ? 'selected' : ''}>FIFO</option>
          <option value="LIFO" ${DATA.settings.inventoryMethod === 'LIFO' ? 'selected' : ''}>LIFO</option>
          <option value="WeightedAvg" ${DATA.settings.inventoryMethod === 'WeightedAvg' ? 'selected' : ''}>Weighted Average</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Auto Backup:</label>
        <input type="checkbox" id="settingsBackup" ${DATA.settings.backupEnabled ? 'checked' : ''}>
        <span style="opacity: 0.7;">Create timestamped backup on each save</span>
      </div>
      
      <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
    </div>

    <div class="card">
      <div class="card-title">About LEDGIOX</div>
      <p><strong>Version:</strong> ${VERSION}</p>
      <p><strong>Mode:</strong> Offline-first, Excel-based</p>
      <p><strong>Storage:</strong> Local Excel (.xlsx) files</p>
      <p><strong>Max Journal Rows per Sheet:</strong> ${MAX_JE_ROWS.toLocaleString()}</p>
      <p style="margin-top: 20px; opacity: 0.7;">To wrap with Tauri: Create new Tauri project and include this HTML file.</p>
    </div>
  `;
}

function saveSettings() {
  DATA.settings.companyName = document.getElementById('settingsCompanyName').value;
  DATA.settings.currency = document.getElementById('settingsCurrency').value;
  DATA.settings.fiscalYearStart = document.getElementById('settingsFiscalYear').value;
  DATA.settings.inventoryMethod = document.getElementById('settingsInventoryMethod').value;
  DATA.settings.backupEnabled = document.getElementById('settingsBackup').checked;
  
  updateUI();
  toast('Settings saved');
}

/* ============================================================
   NEW COMPANY MODAL
   ============================================================ */
document.getElementById('btnNewCompany').addEventListener('click', () => {
  document.getElementById('newCompanyModal').style.display = 'flex';
  document.getElementById('fiscalYearStart').value = new Date().toISOString().split('T')[0];
});

document.querySelectorAll('.close-modal').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
  });
});

document.querySelectorAll('.template-card').forEach(card => {
  card.addEventListener('click', () => {
    document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    selectedTemplate = card.dataset.template;
  });
});

document.getElementById('createCompanyBtn').addEventListener('click', () => {
  const name = document.getElementById('newCompanyName').value.trim();
  const currency = document.getElementById('newCurrency').value;
  const fiscalYear = document.getElementById('fiscalYearStart').value;
  
  if (!name) {
    toast('Please enter company name', 'error');
    return;
  }

  DATA.settings.companyName = name;
  DATA.settings.currency = currency;
  DATA.settings.fiscalYearStart = fiscalYear;
  DATA.settings.inventoryMethod = 'FIFO';
  DATA.settings.backupEnabled = true;
  
  DATA.accounts = TEMPLATES[selectedTemplate];
  DATA.journalEntries = [];
  DATA.customers = [];
  DATA.suppliers = [];
  DATA.inventory = [];
  
  createWorkbook();
  updateUI();
  document.getElementById('newCompanyModal').style.display = 'none';
  renderView('dashboard');
  toast('Company created successfully');
});

/* ============================================================
   IMPORT / EXPORT / SAVE
   ============================================================ */
document.getElementById('btnImport').addEventListener('click', () => {
  document.getElementById('fileInput').click();
});

document.getElementById('fileInput').addEventListener('change', (e) => {
  if (e.target.files[0]) {
    loadWorkbook(e.target.files[0]);
  }
});

document.getElementById('btnExport').addEventListener('click', saveWorkbook);
document.getElementById('btnSave').addEventListener('click', saveWorkbook);

/* ============================================================
   NAVIGATION
   ============================================================ */
document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    renderView(item.dataset.view);
  });
});

/* ============================================================
   INIT
   ============================================================ */
initTheme();
renderView('dashboard');

// Show welcome message
if (!DATA.settings.companyName) {
  setTimeout(() => {
    toast('Welcome to LEDGIOX! Click "New Company" to get started.', 'success');
  }, 500);
}
</script>
</body>
</html>
